<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ore PWS Group (Modern)</title>
    <!-- Google Fonts: Roboto and Material Symbols Outlined -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Material Design 3 Inspired Theme - Android 2025 */

        :root {
            /* Light Theme Palette (Material You - Teal/Blue Base) */
            --md-sys-color-primary: #006A6A;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #9DF2F1;
            --md-sys-color-on-primary-container: #002020;
            --md-sys-color-secondary: #4A6363;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #CCE8E7;
            --md-sys-color-on-secondary-container: #051F1F;
            --md-sys-color-tertiary: #4B607C;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #D3E4FF;
            --md-sys-color-on-tertiary-container: #041C35;
            --md-sys-color-error: #BA1A1A;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #FFDAD6;
            --md-sys-color-on-error-container: #410002;
            --md-sys-color-background: #FAFDFC;
            --md-sys-color-on-background: #191C1C;
            --md-sys-color-surface: #FAFDFC;
            --md-sys-color-on-surface: #191C1C;
            --md-sys-color-surface-variant: #DAE5E4;
            --md-sys-color-on-surface-variant: #3F4948;
            --md-sys-color-outline: #6F7979;
            --md-sys-color-outline-variant: #BFC9C8;
            --md-sys-color-shadow: #000000;
            --md-sys-color-scrim: #000000;
            --md-sys-color-inverse-surface: #2E3131;
            --md-sys-color-inverse-on-surface: #EFF1F0;
            --md-sys-color-inverse-primary: #81D5D4;

            /* Custom Variables */
            --body-font-family: 'Roboto', sans-serif;
            --base-font-size: 16px;
            --border-radius-small: 8px;
            --border-radius-medium: 12px;
            --border-radius-large: 16px;
            --border-radius-full: 999px;
            --elevation-1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --elevation-2: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --elevation-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px rgba(0, 0, 0, 0.3);
            --elevation-4: 0px 6px 10px 4px rgba(0, 0, 0, 0.15), 0px 2px 3px rgba(0, 0, 0, 0.3);
            --elevation-5: 0px 8px 12px 6px rgba(0, 0, 0, 0.15), 0px 4px 4px rgba(0, 0, 0, 0.3);
        }

        /* Dark Theme Palette */
        .dark-theme {
            --md-sys-color-primary: #81D5D4;
            --md-sys-color-on-primary: #003737;
            --md-sys-color-primary-container: #00504F;
            --md-sys-color-on-primary-container: #9DF2F1;
            --md-sys-color-secondary: #B0CCCB;
            --md-sys-color-on-secondary: #1C3534;
            --md-sys-color-secondary-container: #334B4B;
            --md-sys-color-on-secondary-container: #CCE8E7;
            --md-sys-color-tertiary: #B3C8E8;
            --md-sys-color-on-tertiary: #1D314B;
            --md-sys-color-tertiary-container: #344863;
            --md-sys-color-on-tertiary-container: #D3E4FF;
            --md-sys-color-error: #FFB4AB;
            --md-sys-color-on-error: #690005;
            --md-sys-color-error-container: #93000A;
            --md-sys-color-on-error-container: #FFDAD6;
            --md-sys-color-background: #191C1C;
            --md-sys-color-on-background: #E0E3E2;
            --md-sys-color-surface: #191C1C;
            --md-sys-color-on-surface: #E0E3E2;
            --md-sys-color-surface-variant: #3F4948;
            --md-sys-color-on-surface-variant: #BFC9C8;
            --md-sys-color-outline: #899392;
            --md-sys-color-outline-variant: #3F4948;
            /* Shadow and Scrim remain black */
            --md-sys-color-inverse-surface: #E0E3E2;
            --md-sys-color-inverse-on-surface: #191C1C;
            --md-sys-color-inverse-primary: #006A6A;
        }

        /* Global Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: var(--base-font-size);
        }

        body {
            font-family: var(--body-font-family);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 80px; /* Space for bottom nav */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        header {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            box-shadow: var(--elevation-1);
            padding: 0.75rem 1rem;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo img {
            max-height: 40px; /* Adjusted logo size */
            width: auto;
            display: block;
        }

        main {
            padding: 1rem;
            margin-top: 70px; /* Adjusted for header height */
        }

        /* Card */
        .card {
            background-color: var(--md-sys-color-surface-variant); /* Slightly different bg */
            color: var(--md-sys-color-on-surface-variant);
            border-radius: var(--border-radius-large);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--md-sys-color-outline-variant);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .card h2, .card h3 {
            color: var(--md-sys-color-primary);
            margin-bottom: 1rem;
            font-weight: 500;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--md-sys-color-on-surface-variant);
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        textarea,
        select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--border-radius-small);
            font-size: 1rem;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            appearance: none; /* For select */
            -webkit-appearance: none;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px var(--md-sys-color-primary-container);
        }

        select {
             /* Add arrow for select */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24' viewBox='0 -960 960 960' width='24'%3E%3Cpath d='M480-345 240-585l56-56 184 184 184-184 56 56-240 240Z' fill='%23${(getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-on-surface').trim() || '#191C1C').substring(1)}'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5em;
            padding-right: 3rem; /* Space for arrow */
        }
        .dark-theme select {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24' viewBox='0 -960 960 960' width='24'%3E%3Cpath d='M480-345 240-585l56-56 184 184 184-184 56 56-240 240Z' fill='%23${(getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-on-surface').trim() || '#E0E3E2').substring(1)}'/%3E%3C/svg%3E");
        }


        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group-inline {
            flex: 1;
            min-width: 120px;
        }

        /* Buttons */
        button, .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-full); /* Pill shape */
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: var(--elevation-1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:hover, .btn:hover {
            box-shadow: var(--elevation-2);
        }

        button:active, .btn:active {
            transform: scale(0.98);
            box-shadow: none;
        }

        /* Filled Button (Primary Action) */
        button[type="submit"], #submitBtn, #saveUserName, #addVehicle, #exportData, #importData, #saveFerieMalattie, .export-btn, .edit-all-btn, #addEntryBtn {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        button[type="submit"]:hover, #submitBtn:hover, #saveUserName:hover, #addVehicle:hover, #exportData:hover, #importData:hover, #saveFerieMalattie:hover, .export-btn:hover, .edit-all-btn:hover, #addEntryBtn:hover {
             /* Slightly darker/lighter on hover - generate this if needed */
            filter: brightness(90%);
        }
        .dark-theme button[type="submit"]:hover, .dark-theme #submitBtn:hover, .dark-theme #saveUserName:hover, .dark-theme #addVehicle:hover, .dark-theme #exportData:hover, .dark-theme #importData:hover, .dark-theme #saveFerieMalattie:hover, .dark-theme .export-btn:hover, .dark-theme .edit-all-btn:hover, .dark-theme #addEntryBtn:hover {
            filter: brightness(110%);
        }

        /* Error/Destructive Button */
        #clearData, .delete-btn, .delete-ferie-btn, .delete-vehicle-btn {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }
         #clearData:hover, .delete-btn:hover, .delete-ferie-btn:hover, .delete-vehicle-btn:hover {
            filter: brightness(90%);
        }
        .dark-theme #clearData:hover, .dark-theme .delete-btn:hover, .dark-theme .delete-ferie-btn:hover, .dark-theme .delete-vehicle-btn:hover {
            filter: brightness(110%);
        }


        /* Text Button (e.g., Cancel) */
        .form-buttons button:last-child, .close-modal {
             background-color: transparent;
             color: var(--md-sys-color-primary);
             box-shadow: none;
        }
         .form-buttons button:last-child:hover, .close-modal:hover {
            background-color: var(--md-sys-color-primary-container);
         }
        .close-modal { /* Specific style for modal close */
             font-size: 1.75rem;
             padding: 0.5rem;
             border-radius: 50%;
             line-height: 1;
             color: var(--md-sys-color-on-surface-variant);
             font-weight: normal;
             border: none; /* Ensure no border */
        }
        .close-modal:hover {
            color: var(--md-sys-color-on-primary-container);
        }


        /* Small Action Buttons (Edit/Delete in lists) */
        .edit-btn, .delete-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            min-width: 36px;
            min-height: 36px;
            box-shadow: none;
            border-radius: var(--border-radius-small);
            text-transform: none;
            letter-spacing: normal;
            border: 1px solid transparent; /* Base border */
        }
        .edit-btn { /* Make edit look like an Outlined Button */
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-outline);
        }
        .edit-btn:hover {
             background-color: var(--md-sys-color-primary-container);
             border-color: var(--md-sys-color-primary-container);
        }
        .delete-btn {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }
        .delete-btn:hover {
            filter: brightness(95%);
            background-color: var(--md-sys-color-error-container); /* Keep bg */
        }
         .dark-theme .delete-btn:hover {
            filter: brightness(110%);
         }

        /* Material Symbols */
        .material-symbols-outlined {
          font-variation-settings:
          'FILL' 0,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24;
          vertical-align: middle; /* Align icons better with text */
          font-size: 1.25em; /* Slightly larger default size */
          line-height: 1; /* Prevent extra space */
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--md-sys-color-surface-variant); /* Navigation Rail style */
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            padding: 0.5rem 0;
            display: flex;
            justify-content: space-around;
            align-items: stretch; /* Stretch items vertically */
            z-index: 1000;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center content vertically */
            text-decoration: none;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 0.75rem; /* Smaller text */
            padding: 0.25rem 0.75rem;
            border-radius: var(--border-radius-medium);
            transition: all 0.3s ease;
            flex: 1; /* Distribute space */
            text-align: center;
            min-height: 56px; /* Standard height */
            position: relative; /* For indicator positioning */
             overflow: hidden; /* Hide overflow */
        }

        .nav-item .material-symbols-outlined {
            font-size: 1.75rem; /* Larger icon */
            margin-bottom: 2px;
            transition: font-variation-settings 0.3s ease;
        }
         .nav-item span { /* Label */
             display: block;
             line-height: 1.2;
             white-space: nowrap; /* Prevent label wrapping */
         }

        .nav-item.active {
            color: var(--md-sys-color-on-primary-container);
        }
        .nav-item.active .material-symbols-outlined {
            font-variation-settings: 'FILL' 1; /* Fill active icon */
        }

        /* Indicator for active item */
        .nav-item.active::before {
            content: '';
            display: block;
            width: 40px;
            height: 24px;
            background-color: var(--md-sys-color-primary-container);
            border-radius: var(--border-radius-full);
            position: absolute;
            top: 6px; /* Adjust position */
            left: 50%;
            transform: translateX(-50%);
            opacity: 1;
            transition: opacity 0.3s ease, background-color 0.3s ease;
            z-index: -1;
        }
        .nav-item::before { /* Hidden normally */
            content: '';
            display: block;
             width: 40px;
            height: 24px;
            background-color: var(--md-sys-color-primary-container);
            border-radius: var(--border-radius-full);
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
             z-index: -1;
        }


        .nav-item:hover {
            color: var(--md-sys-color-on-surface);
        }


        /* Section Visibility */
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Time Entries List */
        #timeEntries .time-entry {
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            padding: 1rem 0;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
        #timeEntries .time-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .time-entry-info {
            flex-grow: 1;
        }
        .time-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        .time-entry-date {
            font-weight: 500;
            color: var(--md-sys-color-primary);
        }
        .time-entry-hours {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--md-sys-color-secondary);
        }
        .time-entry-details {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin: 0.25rem 0;
            font-size: 0.8rem;
            color: var(--md-sys-color-on-surface-variant);
        }
        .time-entry-details span {
            background-color: var(--md-sys-color-surface);
            padding: 2px 8px;
            border-radius: var(--border-radius-small);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .time-entry-details .material-symbols-outlined {
            font-size: 1em;
            color: var(--md-sys-color-secondary);
        }
        .time-entry-description {
            font-size: 0.9rem;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 0.25rem;
        }
        .entry-buttons {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }


        /* Settings */
        .settings-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--border-radius-medium);
            flex-wrap: wrap; /* Wrap for smaller screens if needed */
        }
        .setting-label {
            font-weight: 500;
             margin-right: 1rem;
             margin-bottom: 0.5rem; /* Add space when wrapping */
             flex-shrink: 0;
        }
        .settings-input {
            flex-grow: 1;
            min-width: 150px; /* Prevent input becoming too small */
             margin-right: 0.5rem; /* Space before button */
        }
        .setting-item > button {
            flex-shrink: 0; /* Prevent button shrinking */
        }
        .setting-item .vehicles-manager { /* Full width for vehicle manager */
            width: 100%;
            margin-top: 0.5rem; /* Space when it's below label */
        }


        /* Toggle Switch (Material Style) */
        .toggle-switch {
            --switch-width: 52px;
            --switch-height: 32px;
            --thumb-size: 24px;
            --track-padding: 4px;

            position: relative;
            display: inline-block;
            width: var(--switch-width);
            height: var(--switch-height);
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--md-sys-color-surface-variant);
            border: 2px solid var(--md-sys-color-outline);
            transition: all .3s ease;
            border-radius: var(--switch-height); /* Fully rounded */
        }
        .toggle-slider:before { /* The Thumb */
            position: absolute;
            content: "";
            height: var(--thumb-size);
            width: var(--thumb-size);
            left: var(--track-padding);
            bottom: var(--track-padding);
            background-color: var(--md-sys-color-outline);
            transition: all .3s ease;
            border-radius: 50%;
            box-shadow: var(--elevation-1);
        }
        input:checked + .toggle-slider {
            background-color: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }
        input:checked + .toggle-slider:before {
            background-color: var(--md-sys-color-on-primary);
            transform: translateX(calc(var(--switch-width) - var(--thumb-size) - 2 * var(--track-padding) - 4px)); /* Adjust 4px for border */
        }


        /* Calendar Styles */
        .calendar-container {
            margin-top: 1rem;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-medium) var(--border-radius-medium) 0 0;
        }
        .calendar-header button {
            background: none;
            border: none;
            font-size: 1.5rem; /* Icon size */
            cursor: pointer;
            color: var(--md-sys-color-on-primary-container);
            padding: 0.5rem;
            border-radius: 50%;
            line-height: 1;
             display: inline-flex; /* Align icon */
             align-items: center;
             justify-content: center;
        }
        .calendar-header button:hover {
            background-color: rgba(0,0,0,0.1);
        }
         .dark-theme .calendar-header button:hover {
              background-color: rgba(255,255,255,0.1);
         }

        .calendar-title {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            font-weight: 500;
            text-align: center;
            flex-grow: 1;
            justify-content: center;
        }
        .calendar-month {
            font-size: 1.25rem;
        }
        .calendar-year {
            font-size: 1rem;
            opacity: 0.8;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px; /* Thin lines between days */
            background-color: var(--md-sys-color-outline-variant); /* Grid lines */
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 0 0 var(--border-radius-medium) var(--border-radius-medium);
            overflow: hidden;
        }
        .calendar-weekday {
            text-align: center;
            font-weight: 500;
            padding: 0.75rem 0.25rem;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        .calendar-day {
            min-height: 90px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }
        .calendar-day:hover {
            background-color: var(--md-sys-color-inverse-surface); /* Use inverse for hover */
            color: var(--md-sys-color-inverse-on-surface);
        }
        .calendar-day.empty {
            background-color: var(--md-sys-color-surface-variant);
            opacity: 0.5;
            cursor: default;
        }
        .calendar-day.empty:hover {
            background-color: var(--md-sys-color-surface-variant);
        }
        .calendar-day.today {
             /* Use outline instead of border */
             outline: 2px solid var(--md-sys-color-primary);
             outline-offset: -2px;
        }
        /* Style day with entries */
        .calendar-day.has-entries .calendar-day-number {
             font-weight: 700;
             color: var(--md-sys-color-primary);
        }
        .calendar-day-number {
            font-weight: 500;
            font-size: 0.875rem;
            width: 24px;
            height: 24px;
            line-height: 24px;
            border-radius: 50%;
            position: absolute;
            top: 4px;
            left: 4px;
            text-align: center;
             z-index: 1; /* Above content */
        }
        .calendar-day.today .calendar-day-number {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        .calendar-day-content {
            margin-top: 28px; /* Space below number */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 100%;
        }
        .calendar-hours {
            font-size: 1rem;
            font-weight: 700;
            color: var(--md-sys-color-primary);
        }
        .calendar-icons {
            display: flex;
            justify-content: center;
             flex-wrap: wrap; /* Wrap icons if needed */
            gap: 4px;
            font-size: 1rem;
            line-height: 1; /* Prevent extra spacing */
        }
        .calendar-icons .material-symbols-outlined {
             font-size: 1.1em;
             color: var(--md-sys-color-secondary);
        }
        .calendar-holiday-name {
            font-size: 0.75rem;
            color: var(--md-sys-color-error);
            font-weight: 500;
            margin-top: auto; /* Push to bottom */
            padding-top: 4px;
             width: 100%; /* Take full width */
        }
         .calendar-day.holiday {
             background-color: var(--md-sys-color-error-container);
             color: var(--md-sys-color-on-error-container);
             outline: none; /* Remove today outline if holiday */
         }
         .calendar-day.holiday .calendar-day-number {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
         }
         .calendar-day.holiday .calendar-holiday-name {
             color: var(--md-sys-color-on-error-container); /* Match text color */
         }

          .calendar-day.ferie {
             background-color: var(--md-sys-color-tertiary-container);
             color: var(--md-sys-color-on-tertiary-container);
             outline: none;
          }
           .calendar-day.ferie .calendar-icons .material-symbols-outlined {
               color: var(--md-sys-color-on-tertiary-container);
           }
            .calendar-day.ferie .calendar-holiday-name {
               color: var(--md-sys-color-on-tertiary-container);
           }

          .calendar-day.malattia {
             background-color: var(--md-sys-color-secondary-container);
             color: var(--md-sys-color-on-secondary-container);
             outline: none;
          }
            .calendar-day.malattia .calendar-icons .material-symbols-outlined {
               color: var(--md-sys-color-on-secondary-container);
           }
             .calendar-day.malattia .calendar-holiday-name {
               color: var(--md-sys-color-on-secondary-container);
           }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050; /* Above nav */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--md-sys-color-scrim); /* Scrim */
            background-color: rgba(0, 0, 0, 0.5); /* Fallback */
            animation: fadeIn 0.3s ease;
             padding: 1rem; /* Padding for scroll */
        }
        .modal-content {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            margin: 5vh auto; /* Vertically centered */
            padding: 1.5rem;
            border: none;
            width: 95%;
            max-width: 600px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--elevation-4);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--md-sys-color-primary);
        }
        .modal-body {
            margin-bottom: 1.5rem;
        }
        .modal-footer {
            text-align: right;
            padding-top: 1rem;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }
         .modal-footer button {
             margin-left: 0.5rem;
         }

        /* Day Details Modal Specifics */
        .day-summary {
            display: grid; /* Use grid for better alignment */
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 1rem;
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: var(--md-sys-color-primary-container);
            border-radius: var(--border-radius-medium);
            color: var(--md-sys-color-on-primary-container);
        }
        .day-summary-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--md-sys-color-primary);
            display: block;
             line-height: 1.1;
        }
        .day-summary-label {
            font-size: 0.8rem;
            color: var(--md-sys-color-on-primary-container);
            opacity: 0.8;
            text-transform: uppercase;
             margin-top: 0.25rem;
             display: block;
        }
        .day-entries {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px; /* Space for scrollbar */
             margin-top: 1rem; /* Space after summary/actions */
        }
        /* Style day entries like time entries */
        .day-entry {
             border-bottom: 1px solid var(--md-sys-color-outline-variant);
             padding: 1rem 0;
             margin-bottom: 0.5rem;
             display: flex; /* Use flex for button alignment */
             justify-content: space-between;
             align-items: flex-start;
             gap: 1rem;
        }
        .day-entry:last-child { border-bottom: none; margin-bottom: 0; }
        .day-entry-info { flex-grow: 1; }
        .day-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
        .day-entry-hours { font-weight: bold; color: var(--md-sys-color-primary); }
        .day-entry-details { display: flex; flex-wrap: wrap; gap: 0.75rem; margin: 0.25rem 0; font-size: 0.8rem; color: var(--md-sys-color-on-surface-variant); }
         .day-entry-details span {
             background-color: var(--md-sys-color-surface);
             padding: 2px 8px;
             border-radius: var(--border-radius-small);
             display: inline-flex;
             align-items: center;
             gap: 4px;
         }
        .day-entry-description { margin-top: 0.25rem; font-size: 0.9rem; color: var(--md-sys-color-on-surface-variant); }
        .day-entry-vehicle {
            font-size: 0.8rem;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 4px;
            padding-left: 8px;
            border-left: 2px solid var(--md-sys-color-outline);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .day-entry-vehicle .material-symbols-outlined { font-size: 1em; }
         .day-entry .entry-buttons { flex-shrink: 0; } /* Prevent buttons shrinking */
        .modal-actions {
             text-align: right;
             margin-bottom: 1rem;
        }

        /* Monthly Summary / Stats */
        .monthly-summary, .stats-container, .monthly-report-stats {
            display: grid; /* Use grid for better spacing */
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            justify-content: space-around; /* Center items */
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border-radius: var(--border-radius-medium);
        }
        .monthly-summary h3 {
            grid-column: 1 / -1; /* Span full width */
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--md-sys-color-secondary);
            font-weight: 500;
        }
        .monthly-stat-item, .stat-card {
            text-align: center;
            padding: 0.75rem;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            border-radius: var(--border-radius-medium);
            box-shadow: var(--elevation-1);
        }
        .monthly-stat-value, .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--md-sys-color-secondary);
            margin: 5px 0;
            display: block;
             line-height: 1.1;
        }
        .monthly-stat-label, .stat-label {
            font-size: 0.8rem;
            color: var(--md-sys-color-on-surface-variant);
            text-transform: uppercase;
             display: block;
             margin-top: 0.25rem;
        }

        /* Contacts Section */
        .contacts-container { display: flex; flex-direction: column; gap: 1.5rem; }
        .contact-address {
            padding: 1rem;
            background-color: var(--md-sys-color-tertiary-container);
            color: var(--md-sys-color-on-tertiary-container);
            border-radius: var(--border-radius-medium);
            margin-bottom: 1rem;
        }
        .contact-address .contact-item, .contact-info .contact-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .contact-address .contact-item .material-symbols-outlined,
        .contact-info .contact-item .material-symbols-outlined {
            color: var(--md-sys-color-tertiary);
            font-size: 1.25rem;
             width: 24px; /* Fixed width for alignment */
             text-align: center;
             flex-shrink: 0;
        }
        .dark-theme .contact-address .contact-item .material-symbols-outlined,
        .dark-theme .contact-info .contact-item .material-symbols-outlined {
            color: var(--md-sys-color-tertiary); /* Keep same color */
        }
        .contact-group h3 {
            color: var(--md-sys-color-secondary);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            font-weight: 500;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            padding-bottom: 0.5rem;
        }
        .contact-card {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--border-radius-medium);
            padding: 1rem;
            box-shadow: var(--elevation-1);
            margin-bottom: 1rem;
            border: 1px solid var(--md-sys-color-outline-variant);
        }
        .contact-name {
            font-weight: 500;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            color: var(--md-sys-color-on-surface);
        }
        .contact-info { display: flex; flex-direction: column; gap: 0.5rem; }
        .contact-item a {
            color: var(--md-sys-color-primary);
            text-decoration: none;
            transition: color 0.2s;
            word-break: break-all; /* Prevent long emails breaking layout */
        }
        .contact-item a:hover {
            text-decoration: underline;
             filter: brightness(80%);
        }
         .dark-theme .contact-item a:hover {
            filter: brightness(120%);
         }

        /* QR Code */
        .qr-code-container {
            text-align: center;
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: var(--border-radius-medium);
        }
        .qr-code-container h4 {
            margin-bottom: 1rem;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }
        #qrcode, #contacts-qrcode {
            display: inline-block;
            padding: 10px;
            background-color: white; /* Keep white for QR */
            border-radius: var(--border-radius-small);
            box-shadow: var(--elevation-1);
            margin: 0 auto;
            min-width: 180px;
            min-height: 180px;
             line-height: 0; /* Prevent extra space below img */
        }
        #qrcode img, #contacts-qrcode img {
            display: block !important;
            max-width: 100% !important;
            height: auto !important;
            margin: 0 auto !important;
        }

        /* Toast / Message */
         #toast-container {
             position: fixed;
             bottom: 90px; /* Above bottom nav */
             left: 50%;
             transform: translateX(-50%);
             z-index: 1100;
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 0.5rem;
             width: fit-content; /* Only as wide as needed */
             max-width: 90%;
         }
        .message, .toast {
            padding: 0.875rem 1.5rem;
            border-radius: var(--border-radius-small);
            color: var(--md-sys-color-on-primary); /* Default */
            background-color: var(--md-sys-color-inverse-surface); /* Use inverse surface */
            color: var(--md-sys-color-inverse-on-surface);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bounce effect */
            box-shadow: var(--elevation-3);
            font-size: 0.9rem;
             width: 100%;
             text-align: center;
        }
        .message.show, .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .message.success, .toast.success {
            background-color: #388E3C; /* Green */
            color: #FFFFFF;
        }
        .message.error, .toast.error {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }
        .toast.warning { background-color: #FFA000; color: #000000;}
        .toast.info { background-color: #1976D2; color: #FFFFFF;}

        /* Monthly Report */
        .monthly-report-container { margin-top: 1.5rem; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            flex-wrap: wrap; /* Wrap on small screens */
            gap: 1rem;
        }
        .section-header h2 { margin: 0; flex-grow: 1; } /* Allow title to grow */
        .section-controls { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;}
        .month-selector select { /* Using standard input style */
            min-width: 150px; /* Ensure dropdown is usable */
        }

        .export-btn.excel-btn {
            background-color: #1D6F42; /* Excel Green */
            color: white;
        }
        .export-btn.excel-btn:hover { background-color: #165231; }

        .monthly-report-content { max-height: 60vh; overflow-y: auto; }
        .monthly-report-item {
            padding: 1rem;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            transition: background-color 0.2s;
        }
        .monthly-report-item:last-child { border-bottom: none; }
        .monthly-report-item:hover { background-color: var(--md-sys-color-surface-variant); }
        .monthly-report-date {
            font-weight: 500;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--md-sys-color-primary);
        }
        .monthly-report-details { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 0.5rem; }
        .monthly-report-detail {
            background-color: var(--md-sys-color-surface);
            padding: 3px 8px;
            border-radius: var(--border-radius-small);
            font-size: 0.8rem;
            color: var(--md-sys-color-on-surface-variant);
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 4px;
        }
        .monthly-report-detail .material-symbols-outlined { font-size: 1.1em; }

        .monthly-report-description, .monthly-report-vehicle {
            font-size: 0.9rem;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 0.25rem;
        }
        .monthly-report-vehicle {
             padding-left: 8px;
             border-left: 2px solid var(--md-sys-color-outline);
             display: inline-flex; /* Align icon */
             align-items: center;
             gap: 4px;
        }
         .monthly-report-vehicle .material-symbols-outlined { font-size: 1em; }
        .monthly-report-empty { text-align: center; padding: 2rem; color: var(--md-sys-color-on-surface-variant); }

        /* Style Ferie/Malattia in report */
         .monthly-report-item.ferie-entry {
             background-color: var(--md-sys-color-tertiary-container);
             color: var(--md-sys-color-on-tertiary-container);
             border-left: 3px solid var(--md-sys-color-tertiary);
             padding-left: calc(1rem - 3px); /* Adjust padding */
         }
          .monthly-report-item.ferie-entry .monthly-report-date { color: var(--md-sys-color-tertiary); }
          .monthly-report-item.ferie-entry .monthly-report-detail { background-color: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface-variant); } /* Reset detail color */
          .monthly-report-item.ferie-entry .monthly-report-description { color: var(--md-sys-color-on-tertiary-container); opacity: 0.9; }

         .monthly-report-item.malattia-entry {
             background-color: var(--md-sys-color-secondary-container);
             color: var(--md-sys-color-on-secondary-container);
             border-left: 3px solid var(--md-sys-color-secondary);
             padding-left: calc(1rem - 3px);
         }
         .monthly-report-item.malattia-entry .monthly-report-date { color: var(--md-sys-color-secondary); }
         .monthly-report-item.malattia-entry .monthly-report-detail { background-color: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface-variant); }
         .monthly-report-item.malattia-entry .monthly-report-description { color: var(--md-sys-color-on-secondary-container); opacity: 0.9; }


         /* Ferie/Malattie Section */
        .ferie-malattie-content { display: flex; flex-direction: column; gap: 1.5rem; }
        .ferie-malattie-form, .ferie-malattie-list {
             background-color: var(--md-sys-color-surface);
             padding: 1.5rem;
             border-radius: var(--border-radius-medium);
             border: 1px solid var(--md-sys-color-outline-variant);
        }
         .ferie-malattie-list h3 {
             color: var(--md-sys-color-secondary);
             margin-bottom: 1rem;
             font-weight: 500;
         }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
             color: var(--md-sys-color-on-surface);
             margin-bottom: 1rem; /* Consistent margin */
             padding: 0.5rem 0; /* Make easier to tap */
        }
        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--md-sys-color-primary); /* Style checkbox */
            margin: 0;
             flex-shrink: 0;
        }
         .checkbox-label span {
             line-height: 1.2;
         }

        .ferie-malattie-entry {
            padding: 1rem 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
         .ferie-malattie-entry:last-child { border-bottom: none; margin-bottom: 0; }
         .ferie-malattie-info { flex-grow: 1; }
         .ferie-malattie-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; flex-wrap: wrap; gap: 0.5rem; }
         .ferie-malattie-type { font-weight: 500; color: var(--md-sys-color-primary); display: inline-flex; align-items: center; gap: 0.25rem; }
         .ferie-malattie-type .material-symbols-outlined { font-size: 1.1em; vertical-align: bottom;}
         .ferie-malattie-date { color: var(--md-sys-color-on-surface-variant); font-size: 0.9rem; }
         .ferie-malattie-note { color: var(--md-sys-color-on-surface-variant); font-style: italic; font-size: 0.9rem; margin-top: 0.25rem; width: 100%; } /* Take full width below */
         .ferie-malattie-actions { flex-shrink: 0; }
         .delete-ferie-btn { /* Using standard delete button style */
             min-width: 40px;
             min-height: 40px;
             padding: 0; /* Remove padding if just icon */
             display: inline-flex; /* Center icon */
             align-items: center;
             justify-content: center;
         }
         .delete-ferie-btn .material-symbols-outlined { font-size: 1.5rem; }


        /* Vehicles Management */
         .vehicles-manager { margin-top: 1rem; }
         .vehicles-form { margin-bottom: 1rem; }
         .vehicles-form input { margin-bottom: 0; } /* Remove bottom margin if inside flex */
         .vehicles-list {
             border: 1px solid var(--md-sys-color-outline-variant);
             border-radius: var(--border-radius-medium);
             padding: 0.5rem;
             background-color: var(--md-sys-color-surface-variant);
             margin-top: 1rem;
             max-height: 200px;
             overflow-y: auto;
         }
         .vehicle-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 0.75rem 1rem;
             margin-bottom: 0.5rem;
             background-color: var(--md-sys-color-surface);
             border-radius: var(--border-radius-small);
             border: 1px solid var(--md-sys-color-outline-variant);
             gap: 1rem; /* Add gap */
         }
         .vehicle-item:last-child { margin-bottom: 0; }
         .vehicle-info { display: flex; flex-direction: column; flex-grow: 1; }
         .vehicle-name { font-weight: 500; color: var(--md-sys-color-on-surface); }
         .vehicle-plate { font-size: 0.8rem; color: var(--md-sys-color-on-surface-variant); }
         .delete-vehicle-btn { /* Using standard delete button style */
              min-width: 40px;
             min-height: 40px;
             padding: 0;
              display: inline-flex; /* Center icon */
             align-items: center;
             justify-content: center;
             flex-shrink: 0;
         }
          .delete-vehicle-btn .material-symbols-outlined { font-size: 1.5rem; }

        /* Date Picker (Flatpickr) Customization */
        .flatpickr-calendar {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            border-radius: var(--border-radius-medium);
            box-shadow: var(--elevation-3);
            border: 1px solid var(--md-sys-color-outline-variant);
            width: auto; /* Adjust width */
             font-family: var(--body-font-family); /* Ensure correct font */
        }
        .flatpickr-months .flatpickr-month {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            fill: var(--md-sys-color-on-primary-container);
            height: 56px; /* Taller header */
             border-radius: var(--border-radius-medium) var(--border-radius-medium) 0 0;
        }
        .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month {
            fill: var(--md-sys-color-on-primary-container);
             top: 16px; /* Adjust icon position */
             padding: 4px; /* Hit area */
             border-radius: 50%;
             transition: background-color 0.2s ease;
        }
        .flatpickr-months .flatpickr-prev-month:hover, .flatpickr-months .flatpickr-next-month:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .dark-theme .flatpickr-months .flatpickr-prev-month:hover, .dark-theme .flatpickr-months .flatpickr-next-month:hover {
             background-color: rgba(255, 255, 255, 0.1);
        }
        .flatpickr-current-month {
            font-size: 1.1rem;
            font-weight: 500;
            padding-top: 16px;
             height: 56px;
             display: flex;
             align-items: center;
             justify-content: center;
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months,
        .flatpickr-current-month input.cur-year {
            background-color: transparent;
            color: var(--md-sys-color-on-primary-container);
            border: none;
            font-weight: 500;
             padding: 2px 4px;
             border-radius: var(--border-radius-small);
        }
         .flatpickr-current-month .flatpickr-monthDropdown-months:hover,
        .flatpickr-current-month input.cur-year:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .dark-theme .flatpickr-current-month .flatpickr-monthDropdown-months:hover,
        .dark-theme .flatpickr-current-month input.cur-year:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        span.flatpickr-weekday {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
             font-size: 0.8em;
             text-transform: uppercase;
             height: 36px;
             line-height: 36px;
        }
        .flatpickr-day {
            color: var(--md-sys-color-on-surface);
            border: 1px solid transparent;
            border-radius: var(--border-radius-full); /* Circular days */
            line-height: 36px; /* Adjust for circle */
            max-width: 38px;
            height: 38px;
             margin: 1px auto; /* Center circle */
             font-weight: 400;
             transition: all 0.2s ease;
        }
        .flatpickr-day:hover, .flatpickr-day:focus {
            background-color: var(--md-sys-color-surface-variant);
            border-color: var(--md-sys-color-surface-variant);
             color: var(--md-sys-color-on-surface-variant);
        }
        .flatpickr-day.today {
             border-color: var(--md-sys-color-primary);
             color: var(--md-sys-color-primary);
        }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange,
        .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover {
            background-color: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        .flatpickr-day.inRange {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            box-shadow: none;
            border-color: var(--md-sys-color-primary-container);
            border-radius: 0; /* Square in-range */
        }
        .flatpickr-day.startRange, .flatpickr-day.endRange {
            border-radius: var(--border-radius-full); /* Ensure start/end are round */
        }
        .flatpickr-day.disabled, .flatpickr-day.disabled:hover {
            color: var(--md-sys-color-on-surface-variant);
            opacity: 0.5;
            background-color: transparent;
            border-color: transparent;
            cursor: default;
        }


         /* Date indicator styling */
        #dateIndicator div {
            background-color: var(--md-sys-color-primary-container) !important;
            color: var(--md-sys-color-on-primary-container) !important;
            padding: 10px 15px !important;
            border-radius: var(--border-radius-medium) !important;
            margin: 10px 0 !important;
            font-size: 1.1rem !important;
            text-align: center;
            font-weight: 500 !important;
            cursor: pointer;
            box-shadow: var(--elevation-1);
            transition: background-color 0.2s ease, filter 0.2s ease;
             display: flex; /* Align icon and text */
             align-items: center;
             justify-content: center;
             gap: 0.5rem;
        }
         #dateIndicator div:hover {
             filter: brightness(95%);
         }
          .dark-theme #dateIndicator div:hover {
             filter: brightness(110%);
         }

        #dateIndicator .material-symbols-outlined {
             font-size: 1.2em;
         }
         #dateIndicator span {
             vertical-align: middle;
         }

         /* Hide original date input and label */
         #date { display: none !important; }
         label[for='date'] { display: none !important; }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            html { font-size: 15px; }
            .container { padding: 0.75rem; }
            main { padding: 0.75rem; margin-top: 65px; }
            .card { padding: 1rem; margin-bottom: 1rem; }
            .bottom-nav { padding: 0.25rem 0; }
            .nav-item { font-size: 0.65rem; min-height: 52px; padding: 0.25rem 0.5rem; }
            .nav-item .material-symbols-outlined { font-size: 1.5rem; }
            .nav-item.active::before { width: 36px; height: 20px; top: 4px;}
            .nav-item::before { width: 36px; height: 20px; top: 4px;}
            .form-row { flex-direction: column; gap: 0; } /* Stack inline groups */
            .form-group-inline { margin-bottom: 1rem; }

            .modal-content { width: 95%; margin: 5vh auto; padding: 1rem; }
            .modal-title { font-size: 1.25rem; }
            .day-summary-value { font-size: 1.5rem; }

            .calendar-day { min-height: 60px; padding: 4px; }
            .calendar-day-number { font-size: 0.75rem; width: 20px; height: 20px; line-height: 20px; top: 2px; left: 2px;}
            .calendar-day-content { margin-top: 24px; }
            .calendar-hours { font-size: 0.8rem; }
            .calendar-icons { font-size: 0.8rem; }
            .calendar-icons .material-symbols-outlined { font-size: 1em; }
            .calendar-holiday-name { font-size: 0.65rem; }
            .calendar-weekday { font-size: 0.7rem; padding: 0.5rem 0.1rem; }

            .monthly-summary, .stats-container, .monthly-report-stats { gap: 0.5rem; padding: 0.75rem; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
            .monthly-stat-item, .stat-card { min-width: auto; padding: 0.5rem; }
            .monthly-stat-value, .stat-value { font-size: 1.25rem; }
            .monthly-stat-label, .stat-label { font-size: 0.7rem; }

            .section-header { flex-direction: column; align-items: stretch; }
            .section-controls { justify-content: center; width: 100%; }
             .section-controls .month-selector { flex-grow: 1; } /* Allow selector to grow */
             .section-controls button { width: 100%; margin-top: 0.5rem; } /* Stack button */

            .vehicles-form div { flex-direction: column; gap: 0.5rem; align-items: stretch; }
            .vehicles-form input { margin-right: 0; }
            .vehicles-form button { width: 100%; margin-top: 0.5rem; }

            .setting-item { flex-direction: column; align-items: stretch; }
             .setting-item .setting-label { margin-bottom: 0.5rem; }
             .setting-item > div { width: 100%; } /* Make input+button full width */
             .setting-item > button { margin-top: 0.5rem; width: 100%; }
             .setting-item .toggle-switch { align-self: flex-end; margin-top: 0.5rem; } /* Align toggle right */
        }

        @media (max-width: 480px) {
             html { font-size: 14px; }
            .container { padding: 0.5rem; }
             main { padding: 0.5rem; margin-top: 60px; }
             .card { padding: 0.75rem; }
             button, .btn { padding: 0.6rem 1.2rem; font-size: 0.8rem; }
             .nav-item { font-size: 0.6rem; }
              .nav-item .material-symbols-outlined { font-size: 1.4rem; }
             .logo img { max-height: 35px; }
             header { padding: 0.5rem 1rem; }
             #dateIndicator div { font-size: 1rem !important; }

             /* Stack time inputs */
             .time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; } /* Keep side-by-side if possible */
             .time-row .form-group { margin-bottom: 0.5rem; }

             .day-summary { grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 0.5rem; padding: 0.5rem;}
             .day-summary-value { font-size: 1.2rem; }
             .day-summary-label { font-size: 0.7rem; }

             .monthly-summary, .stats-container, .monthly-report-stats { grid-template-columns: 1fr 1fr; } /* Two columns */
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="https://i.imgur.com/BnllByD.png"
                     alt="PWS Logo">
            </div>
            <div class="header-actions">
                <!-- Header actions can go here -->
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Sezione Home -->
            <div id="home-section" class="section active">
                <div class="card">
                    <h2>Inserisci Ore</h2>
                    <div class="form-container">
                        <form id="timeEntryForm">
                            <div class="form-group">
                                <!-- Label hidden via CSS, Date indicator shown below -->
                                <label for="date">Data:</label>
                                <input type="text" id="date" class="form-control datepicker" required>
                                <div id="dateIndicator" title="Clicca per cambiare data">
                                    <!-- Indicator content set by JS -->
                                    <div>
                                        <span class="material-symbols-outlined">calendar_today</span>
                                        <span>Seleziona una data</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="vehicleSelect">Mezzo:</label>
                                <select id="vehicleSelect" class="form-control">
                                    <option value="">-- Seleziona un mezzo --</option>
                                    <!-- Dynamic options -->
                                </select>
                            </div>

                            <div class="time-row">
                                <div class="form-group">
                                    <label for="startTime">Ora Inizio:</label>
                                    <input type="text" id="startTime" class="form-control time-input" placeholder="Es. 7" required>
                                </div>
                                <div class="form-group">
                                    <label for="endTime">Ora Fine:</label>
                                    <input type="text" id="endTime" class="form-control time-input" placeholder="Es. 17" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="breakTime">Pausa (ore):</label>
                                <input type="number" id="breakTime" class="form-control compact-input" step="0.5" min="0" value="0.5" required>
                            </div>

                            <div class="form-group">
                                <label for="notturne">Ore Notturne:</label>
                                <input type="number" id="notturne" class="form-control compact-input" step="0.5" min="0">
                            </div>

                            <div class="form-group">
                                <label for="transferta">Ore Trasferta:</label>
                                <input type="number" id="transferta" class="form-control compact-input" step="0.5" min="0">
                            </div>

                            <div class="form-group">
                                <label for="totalHours">Ore Totali:</label>
                                <input type="number" id="totalHours" class="form-control compact-input" readonly>
                            </div>

                            <div class="form-group">
                                <label for="description">Descrizione:</label>
                                <input type="text" id="description" class="form-control" placeholder="Inserisci una descrizione">
                            </div>

                            <div class="form-group" style="margin-top: 20px; text-align: right;">
                                <button type="submit" id="submitBtn">
                                    <span class="material-symbols-outlined">save</span> Salva
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h2>Ultime Entrate</h2>
                    <div id="timeEntries">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Sezione Calendario -->
            <div id="calendar-section" class="section">
                <div class="card">
                    <h2>Calendario</h2>
                    <div class="calendar-container" id="calendarEntries">
                         <!-- Calendar generated by JS -->
                    </div>
                    <div class="monthly-summary" id="monthlySummary">
                        <h3>Riepilogo Mensile</h3>
                        <div class="monthly-stats">
                            <div class="monthly-stat-item">
                                <span class="monthly-stat-value" id="monthlyTotalHours">0h</span>
                                <span class="monthly-stat-label">Ore Totali</span>
                            </div>
                            <div class="monthly-stat-item">
                                <span class="monthly-stat-value" id="monthlyWorkDays">0</span>
                                <span class="monthly-stat-label">Giorni Lavorati</span>
                            </div>
                            <div class="monthly-stat-item">
                                <span class="monthly-stat-value" id="monthlyTransferta">0h</span>
                                <span class="monthly-stat-label">Ore Trasferta</span>
                            </div>
                            <div class="monthly-stat-item">
                                <span class="monthly-stat-value" id="monthlyNotturne">0h</span>
                                <span class="monthly-stat-label">Ore Notturne</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sezione Impostazioni -->
            <div id="settings-section" class="section">
                <div class="card">
                    <h2>Impostazioni</h2>
                    <div class="settings-container">
                        <div class="setting-item">
                            <span class="setting-label">Tema Scuro</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="darkTheme">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <label for="userName" class="setting-label">Nome Utente</label>
                            <div style="display: flex; gap: 10px; flex-grow: 1;">
                                <input type="text" id="userName" class="settings-input" placeholder="Inserisci il tuo nome">
                                <button id="saveUserName">
                                    <span class="material-symbols-outlined">save</span> Salva
                                </button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Esporta Dati</span>
                            <button id="exportData">
                                <span class="material-symbols-outlined">download</span> Esporta Dati
                            </button>
                        </div>
                         <div class="setting-item">
                            <span class="setting-label">Importa Dati</span>
                            <button id="importData">
                                <span class="material-symbols-outlined">upload</span> Importa Dati
                            </button>
                        </div>

                        <div class="setting-item" style="flex-direction: column; align-items: stretch;">
                             <span class="setting-label" style="margin-bottom: 1rem;">Gestione Mezzi</span>
                            <div class="vehicles-manager">
                                <div class="vehicles-form">
                                    <div style="display: flex; gap: 10px; width: 100%; margin-bottom: 10px; flex-wrap: wrap;">
                                        <input type="text" id="vehicleName" class="settings-input" placeholder="Nome mezzo" style="flex: 2 1 150px;">
                                        <input type="text" id="vehiclePlate" class="settings-input" placeholder="Targa (opzionale)" style="flex: 1 1 100px;">
                                        <button id="addVehicle" style="flex-shrink: 0;">
                                             <span class="material-symbols-outlined">add</span> Aggiungi
                                        </button>
                                    </div>
                                </div>
                                <div id="vehiclesList" class="vehicles-list" style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                                    <!-- Dynamic list -->
                                </div>
                                <div style="font-size: 0.8rem; color: var(--md-sys-color-on-surface-variant); margin-top: 5px;">
                                    Nota: è possibile inserire fino a un massimo di 10 mezzi.
                                </div>
                            </div>
                        </div>

                        <div class="setting-item">
                            <span class="setting-label">Cancella Dati</span>
                            <button id="clearData" class="delete-btn">
                                <span class="material-symbols-outlined">delete_forever</span> Cancella Tutto
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sezione Contatti -->
            <div id="contacts-section" class="section">
                <div class="card">
                    <h2>Contatti PWS Group</h2>

                    <div class="contact-address">
                        <div class="contact-item">
                            <span class="material-symbols-outlined">location_on</span>
                            <span>Trezzano S.N(MI) 20090, via G.Boccaccio, 95/c</span>
                        </div>
                        <div class="contact-item">
                             <span class="material-symbols-outlined">call</span>
                            <span>Tel: 02 93219393</span>
                        </div>
                    </div>

                    <div class="qr-code-container">
                        <h4>Scansiona il QR Code per visitare il nostro sito web</h4>
                        <div id="qrcode">
                            <!-- QR code generated by JS -->
                        </div>
                    </div>

                    <div class="qr-code-container">
                        <h4>Scansiona il QR Code per copiare i contatti e l'indirizzo</h4>
                        <div id="contacts-qrcode">
                             <!-- QR code generated by JS -->
                        </div>
                    </div>

                    <div class="contacts-container">
                        <div class="contact-group">
                            <h3>CEO PWS Group</h3>
                            <div class="contact-card">
                                <div class="contact-name">Marcello Cipriani</div>
                                <div class="contact-info">
                                    <div class="contact-item">
                                        <span class="material-symbols-outlined">call</span>
                                        <a href="tel:+393481282035">+39.348.1282035</a>
                                    </div>
                                    <div class="contact-item">
                                        <span class="material-symbols-outlined">mail</span>
                                        <a href="mailto:m.cipriani@pwsdecoart.it">m.cipriani@pwsdecoart.it</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                         <div class="contact-group">
                            <h3>Operation Director</h3>
                            <div class="contact-card">
                                <div class="contact-name">Mauro Pirovano</div>
                                <div class="contact-info">
                                    <div class="contact-item">
                                         <span class="material-symbols-outlined">call</span>
                                        <a href="tel:+393341041545">+39.334.1041545</a>
                                    </div>
                                    <div class="contact-item">
                                        <span class="material-symbols-outlined">mail</span>
                                        <a href="mailto:m.pirovano@pwsdecoart.it">m.pirovano@pwsdecoart.it</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="contact-group">
                            <h3>Sales Director</h3>
                            <div class="contact-card">
                                <div class="contact-name">Danilo Rosa</div>
                                <div class="contact-info">
                                     <div class="contact-item">
                                        <span class="material-symbols-outlined">mail</span>
                                        <a href="mailto:d.rosa@pwsdecoart.it">d.rosa@pwsdecoart.it</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                         <div class="contact-group">
                            <h3>Commerciale</h3>
                            <div class="contact-card">
                                <div class="contact-name">Roberto Bonzanini</div>
                                <div class="contact-info">
                                    <div class="contact-item">
                                         <span class="material-symbols-outlined">mail</span>
                                        <a href="mailto:r.bonzanini@pwsdecoart.it">r.bonzanini@pwsdecoart.it</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="contact-group">
                            <h3>Ufficio Tecnico</h3>
                            <div class="contact-card">
                                <div class="contact-name">Nicola Manniello</div>
                                <div class="contact-info">
                                     <div class="contact-item">
                                         <span class="material-symbols-outlined">mail</span>
                                        <a href="mailto:n.manniello@pwsdecoart.it">n.manniello@pwsdecoart.it</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="contact-group">
                            <h3>Ufficio Grafico</h3>
                            <div class="contact-card">
                                <div class="contact-name">Claudia Favagrossa</div>
                                <div class="contact-info">
                                    <div class="contact-item">
                                         <span class="material-symbols-outlined">mail</span>
                                        <a href="mailto:c.favagrossa@pwsdecoart.it">c.favagrossa@pwsdecoart.it</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="contact-group">
                            <h3>Amministrazione</h3>
                            <div class="contact-card">
                                <div class="contact-name">Daniela Dicensi</div>
                                <div class="contact-info">
                                    <div class="contact-item">
                                         <span class="material-symbols-outlined">mail</span>
                                        <a href="mailto:d.dicensi@pwsdecoart.it">d.dicensi@pwsdecoart.it</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Add other contacts similarly -->
                    </div>
                </div>
            </div>

             <!-- Sezione Riepilogo Mensile -->
            <div id="monthly-report-section" class="section">
                <div class="card">
                    <div class="section-header">
                        <h2>Riepilogo Mensile</h2>
                        <div class="section-controls">
                            <div class="month-selector">
                                <select id="exportMonthSelect"></select>
                            </div>
                            <button id="exportMonthlyExcel" class="export-btn excel-btn">
                                <span class="material-symbols-outlined">download_for_offline</span> Esporta Excel
                            </button>
                        </div>
                    </div>
                    <div id="monthlyReportContent" class="monthly-report-content">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

             <!-- Sezione Ferie/malattie -->
            <div id="ferie-malattie-section" class="section">
                <div class="card">
                    <h2>Ferie e Malattie</h2>
                    <div class="ferie-malattie-content">
                        <div class="ferie-malattie-form">
                            <div class="form-group">
                                <label for="ferieMalattieType">Tipo</label>
                                <select id="ferieMalattieType" class="form-control">
                                    <option value="ferie">Ferie</option>
                                    <option value="malattia">Malattia</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="multipleDays" class="form-control">
                                    <span>Più giorni</span>
                                </label>
                            </div>
                            <div id="singleDateGroup" class="form-group">
                                <label for="ferieMalattieDate">Data</label>
                                <input type="text" id="ferieMalattieDate" class="form-control datepicker-ferie" placeholder="gg/mm/aaaa">
                            </div>
                            <div id="dateRangeGroup" class="form-group" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group-inline">
                                        <label for="ferieMalattieStartDate">Data inizio</label>
                                        <input type="text" id="ferieMalattieStartDate" class="form-control datepicker-ferie" placeholder="gg/mm/aaaa">
                                    </div>
                                    <div class="form-group-inline">
                                        <label for="ferieMalattieEndDate">Data fine</label>
                                        <input type="text" id="ferieMalattieEndDate" class="form-control datepicker-ferie" placeholder="gg/mm/aaaa">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="ferieMalattieNote">Note</label>
                                <textarea id="ferieMalattieNote" class="form-control" rows="3" placeholder="Aggiungi note (opzionale)"></textarea>
                            </div>
                            <div style="text-align: right;">
                                <button id="saveFerieMalattie">
                                    <span class="material-symbols-outlined">save</span> Salva Assenza
                                </button>
                            </div>
                        </div>
                        <div class="ferie-malattie-list">
                            <h3>Riepilogo Assenze</h3>
                            <div id="ferieMalattieEntries">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-section="home-section">
            <span class="material-symbols-outlined">home</span>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item" data-section="calendar-section">
            <span class="material-symbols-outlined">calendar_month</span>
            <span>Calendario</span>
        </a>
        <a href="#" class="nav-item" data-section="monthly-report-section">
             <span class="material-symbols-outlined">summarize</span>
            <span>Riepilogo</span>
        </a>
         <a href="#" class="nav-item" data-section="ferie-malattie-section">
            <span class="material-symbols-outlined">hotel_class</span> <!-- or event_busy / medical_services -->
            <span>Assenze</span>
        </a>
        <a href="#" class="nav-item" data-section="contacts-section">
            <span class="material-symbols-outlined">contacts</span>
            <span>Contatti</span>
        </a>
        <a href="#" class="nav-item" data-section="settings-section">
            <span class="material-symbols-outlined">settings</span>
            <span>Impostazioni</span>
        </a>
    </nav>

    <!-- Modale per i dettagli del giorno -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Dettagli Giorno</h3>
                <button class="close-modal">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="day-summary">
                    <div class="day-summary-item">
                        <span class="day-summary-value" id="modalTotalHours">0h</span>
                        <span class="day-summary-label">Ore Totali</span>
                    </div>
                    <div class="day-summary-item">
                        <span class="day-summary-value" id="modalTransferta">0h</span>
                        <span class="day-summary-label">Trasferta</span>
                    </div>
                    <div class="day-summary-item">
                        <span class="day-summary-value" id="modalNotturne">0h</span>
                        <span class="day-summary-label">Notturne</span>
                    </div>
                </div>
                 <div class="modal-actions">
                     <button id="addEntryBtn"> <!-- Style inherited from primary buttons -->
                         <span class="material-symbols-outlined">add_circle</span> Aggiungi Nuova Voce
                     </button>
                 </div>
                <div class="day-entries" id="modalEntries">
                    <!-- Dynamic entries -->
                </div>
            </div>
            <!-- Optional Footer -->
            <!-- <div class="modal-footer">
                 <button class="btn text-btn">Azione Footer</button>
            </div> -->
        </div>
    </div>

    <!-- Toast Notification Placeholder -->
    <div id="toast-container"></div>


    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Fixed initDatepicker definition to prevent ReferenceError
        function initDatepicker() {
            const dateInput = document.getElementById('date');
            if (!dateInput) return;

            console.log("Inizializzazione datepicker Material Design");

            try {
                // Hide the date input field visually using CSS added earlier
                // dateInput.style.display = 'none'; // No longer needed if CSS handles it

                // Destroy any existing instance
                const oldInstance = dateInput._flatpickr;
                if (oldInstance) {
                    try {
                        oldInstance.destroy();
                        console.log("Istanza Flatpickr precedente distrutta.");
                    } catch (err) {
                        console.warn("Errore durante la distruzione dell'istanza precedente:", err);
                    }
                }

                // Set today's date if no date is set
                if (!dateInput.value) {
                    const today = new Date();
                    dateInput.value = formatDateForInput(today); // Use helper
                    console.log("Nessuna data impostata, uso oggi:", dateInput.value);
                } else {
                    console.log("Data già impostata:", dateInput.value);
                }

                // Store a global reference to track the last selected date
                window.lastSelectedDate = dateInput.value;
                console.log("Data iniziale salvata globalmente:", window.lastSelectedDate);

                // Configure flatpickr
                const fp = flatpickr(dateInput, {
                    dateFormat: "d/m/Y",
                    locale: "it",
                    allowInput: false, // Disable direct input, use picker only
                    defaultDate: dateInput.value,
                    disableMobile: true, // Use custom mobile handling & style
                    appendTo: document.body, // Append to body to avoid layout issues
                    onChange: function(selectedDates, dateStr, instance) {
                        console.log("Datepicker onChange:", dateStr);

                        // Sometimes dateStr might be empty if cleared, handle it
                        if(dateStr && selectedDates.length > 0) {
                            window.lastSelectedDate = dateStr;
                            dateInput.value = dateStr; // Update hidden input
                            updateDateIndicator(selectedDates[0]); // Update visual indicator

                            if (typeof loadExistingEntry === 'function') {
                                loadExistingEntry(dateStr);
                            }
                        } else if (!dateStr) {
                            // Handle case where date is cleared (if allowInput was true)
                             const today = new Date();
                             instance.setDate(today, true); // Reset to today if cleared
                             console.log("Data cancellata, reimpostata a oggi.");
                        }
                    },
                    onReady: function(selectedDates, dateStr, instance) {
                         updateDateIndicator(instance.selectedDates[0] || new Date()); // Initial update
                         console.log("Flatpickr pronto.");
                     },
                    // onClose needed? Maybe not if onChange handles everything
                });

                // Make the date indicator clickable to open the datepicker
                const dateIndicator = document.getElementById('dateIndicator');
                if (dateIndicator) {
                    dateIndicator.style.cursor = 'pointer';
                    dateIndicator.title = 'Clicca per cambiare data';

                    dateIndicator.addEventListener('click', function() {
                        console.log("Click sull'indicatore data - apertura datepicker");
                        if (fp && !fp.isOpen) { // Prevent opening if already open
                            fp.open();
                        } else if (fp && fp.isOpen) {
                            fp.close(); // Allow closing by clicking again
                        }
                    });
                }

                console.log("Datepicker inizializzato con successo - input nascosto e indicatore data cliccabile");
            } catch (error) {
                console.error("Errore nell'inizializzazione del datepicker:", error);
                 // Fallback: Show basic input if error occurs (though CSS hides label/input now)
                 // Consider adding a visible fallback mechanism if robust error handling is needed
                 const today = new Date();
                 dateInput.value = formatDateForInput(today);
                 const dateIndicator = document.getElementById('dateIndicator');
                 if(dateIndicator) dateIndicator.innerHTML = `<div>Errore nel caricamento del calendario. Data: ${dateInput.value}</div>`;
            }
        }

        // Helper to update the visual date indicator
        function updateDateIndicator(date) {
            const dateIndicator = document.getElementById('dateIndicator');
             if (!dateIndicator || !date || isNaN(date.getTime())) {
                 console.warn("updateDateIndicator: Indicatore non trovato o data non valida");
                 if(dateIndicator) {
                    dateIndicator.innerHTML = `<div><span class='material-symbols-outlined'>calendar_today</span><span>Data non valida</span></div>`;
                 }
                 return;
             };

            try {
                 const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                 const italianDate = date.toLocaleDateString('it-IT', options);

                // Update the indicator with Material icon
                dateIndicator.innerHTML = `
                    <div title="Clicca per cambiare data">
                        <span class="material-symbols-outlined">calendar_month</span>
                        <span style="font-weight: 500;">${italianDate}</span>
                    </div>
                `;
            } catch (e) {
                console.error("Errore nell'aggiornamento dell'indicatore:", e);
                dateIndicator.innerHTML = `<div><span class='material-symbols-outlined'>calendar_today</span><span>Errore data</span></div>`;
            }
        }

        // Function to show toast notification
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
             if (!container) {
                 console.error("Toast container non trovato!");
                 return; // Exit if container doesn't exist
             }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            // Trigger transition for appearance
            requestAnimationFrame(() => {
                 // We need a double requestAnimationFrame to ensure the transition works on add
                requestAnimationFrame(() => {
                     toast.classList.add('show');
                 });
            });


            // Remove toast after duration
            setTimeout(() => {
                toast.classList.remove('show');
                // Remove from DOM after transition ends
                toast.addEventListener('transitionend', () => {
                    // Check if the element still has a parent before removing
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, { once: true }); // Use {once: true} for cleaner event handling
            }, duration);
        }

        // Global DOMContentLoaded listener
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM completamente caricato e analizzato');

             // --- Theme Initialization ---
             const darkThemeToggle = document.getElementById('darkTheme');
             if(darkThemeToggle) {
                 const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                 const savedTheme = localStorage.getItem('theme');

                 if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                     document.body.classList.add('dark-theme');
                     darkThemeToggle.checked = true;
                     console.log("Tema scuro applicato (salvato o preferito).");
                 } else {
                     document.body.classList.remove('dark-theme');
                     darkThemeToggle.checked = false;
                      console.log("Tema chiaro applicato.");
                 }

                 darkThemeToggle.addEventListener('change', () => {
                     document.body.classList.toggle('dark-theme');
                     const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
                     localStorage.setItem('theme', currentTheme);
                     console.log(`Tema cambiato a: ${currentTheme}`);
                      // Re-initialize things that might depend on theme (like select arrows)
                      // We might need to force a redraw or reapply styles if dynamic SVG fill doesn't update
                      setTimeout(() => {
                          console.log("Forzando aggiornamento stile select (potrebbe non essere necessario)");
                          const selects = document.querySelectorAll('select');
                          selects.forEach(s => { s.style.display = 'none'; s.offsetHeight; s.style.display = ''; });
                      }, 50);
                 });
             } else {
                  console.warn("Toggle tema scuro non trovato.");
             }


            // --- Initialize datepicker ---
            if (typeof initDatepicker === 'function') {
                initDatepicker();
            } else {
                console.error("initDatepicker function not found!");
            }

             // --- Initialize other pickers ---
             if (typeof initFerieMalattieDatepickers === 'function') {
                 initFerieMalattieDatepickers();
             }


             // --- Load User Name ---
            const userNameInput = document.getElementById('userName');
            const saveUserNameBtn = document.getElementById('saveUserName');
            if (userNameInput) {
                const savedUserName = localStorage.getItem('userName');
                if (savedUserName) {
                    userNameInput.value = savedUserName;
                    console.log("Nome utente caricato:", savedUserName);
                }
                if (saveUserNameBtn) {
                    saveUserNameBtn.addEventListener('click', () => {
                        const nameToSave = userNameInput.value.trim();
                        localStorage.setItem('userName', nameToSave);
                        showToast('Nome utente salvato!', 'success');
                         console.log("Nome utente salvato:", nameToSave);
                    });
                } else {
                     console.warn("Pulsante salvataggio nome utente non trovato.");
                }
            } else {
                console.warn("Input nome utente non trovato.");
            }


            // --- Navigation Logic ---
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.section');

            if (navItems.length > 0 && sections.length > 0) {
                navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetSectionId = item.getAttribute('data-section');
                        console.log(`Navigazione a: ${targetSectionId}`);

                        // Update active nav item
                        navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');

                        // Update active section
                        let sectionFound = false;
                        sections.forEach(section => {
                            if (section.id === targetSectionId) {
                                section.classList.add('active');
                                sectionFound = true;
                            } else {
                                section.classList.remove('active');
                            }
                        });
                         if (!sectionFound) {
                             console.error(`Sezione ${targetSectionId} non trovata!`);
                         }

                         // Scroll to top of the main content area for clarity
                         const mainElement = document.querySelector('main');
                         if(mainElement) {
                             mainElement.scrollTo({ top: 0, behavior: 'smooth' });
                         }

                        // Load data specific to the section if needed (and function exists)
                         if (targetSectionId === 'calendar-section' && typeof loadCalendarData === 'function') loadCalendarData();
                         if (targetSectionId === 'settings-section' && typeof loadVehicles === 'function') loadVehicles();
                         if (targetSectionId === 'monthly-report-section' && typeof initMonthlyReport === 'function') initMonthlyReport();
                         if (targetSectionId === 'ferie-malattie-section' && typeof initFerieMalattieSection === 'function') initFerieMalattieSection(); // Changed to init function

                    });
                });
            } else {
                console.warn("Elementi di navigazione o sezioni non trovati.");
            }


            // --- Form submission ---
            const form = document.getElementById('timeEntryForm');
            if(form) {
                 form.addEventListener('submit', saveTimeEntry);
                 // Auto-calculate total hours
                 ['startTime', 'endTime', 'breakTime'].forEach(id => {
                     const input = document.getElementById(id);
                     if(input) {
                         input.addEventListener('input', calculateTotalHours);
                     } else {
                         console.warn(`Input ${id} non trovato per il calcolo automatico.`);
                     }
                 });
                 calculateTotalHours(); // Initial calculation
            } else {
                 console.warn("Form inserimento ore non trovato.");
            }


            // --- Load initial data ---
            if (typeof loadTimeEntries === 'function') loadTimeEntries();
            if (typeof loadVehicles === 'function') loadVehicles(); // Load vehicles for the select dropdown on home
            if (typeof loadFerieMalattieTypes === 'function') loadFerieMalattieTypes();


            // --- Settings actions ---
            const exportBtn = document.getElementById('exportData');
            if(exportBtn && typeof exportData === 'function') {
                exportBtn.addEventListener('click', exportData);
            } else if (!exportBtn) { console.warn("Pulsante Esporta Dati non trovato."); }

             const importBtn = document.getElementById('importData');
            if(importBtn && typeof triggerImport === 'function') {
                importBtn.addEventListener('click', triggerImport);
            } else if (!importBtn) { console.warn("Pulsante Importa Dati non trovato."); }

            const clearBtn = document.getElementById('clearData');
            if(clearBtn && typeof clearAllData === 'function') {
                clearBtn.addEventListener('click', clearAllData);
            } else if (!clearBtn) { console.warn("Pulsante Cancella Dati non trovato."); }

             // --- Vehicle Management ---
             const addVehicleBtn = document.getElementById('addVehicle');
             if(addVehicleBtn && typeof addVehicle === 'function') {
                 addVehicleBtn.addEventListener('click', addVehicle);
             } else if (!addVehicleBtn) { console.warn("Pulsante Aggiungi Mezzo non trovato."); }

            // --- Monthly Report Initialization ---
            // initMonthlyReport(); // Called when section becomes active

            // --- Ferie/Malattie Initialization ---
             // initFerieMalattieSection(); // Called when section becomes active


             // --- QR Code Generation (using library) ---
             if (typeof generateQRCodes === 'function') {
                 generateQRCodes();
             } else {
                 console.warn("Funzione generateQRCodes non trovata.");
             }


            // --- Modal Handling ---
             const modal = document.getElementById('dayModal');
             if (modal) {
                 const closeModalBtn = modal.querySelector('.close-modal');
                 const addEntryModalBtn = modal.querySelector('#addEntryBtn');

                 if(closeModalBtn) {
                     closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
                 } else { console.warn("Pulsante chiusura modale non trovato."); }

                 // Close modal if clicking on the background scrim
                 modal.addEventListener('click', (event) => {
                     if (event.target === modal) {
                         modal.style.display = 'none';
                     }
                 });

                  if (addEntryModalBtn) {
                     addEntryModalBtn.addEventListener('click', () => {
                         const dateStr = window.lastClickedDate; // Assume this is set when modal opens

                         if (dateStr) {
                             console.log(`Aggiunta voce da modale per data: ${dateStr}`);
                             // Navigate to home section
                              const homeNavItem = document.querySelector('.nav-item[data-section="home-section"]');
                              if (homeNavItem) {
                                  homeNavItem.click(); // Simulate click to navigate
                              } else {
                                   console.error("Nav item Home non trovato per la navigazione.");
                                   showToast("Errore: Impossibile navigare alla sezione Home.", "error");
                                   return;
                              }


                             // Wait for navigation and section switch animation, then set date and focus
                             setTimeout(() => {
                                 const dateInput = document.getElementById('date');
                                 const startTimeInput = document.getElementById('startTime');
                                 if (dateInput && startTimeInput) {
                                     // Find the flatpickr instance and set date
                                     if (dateInput._flatpickr) {
                                         dateInput._flatpickr.setDate(dateStr, true); // true triggers onChange
                                         console.log(`Data ${dateStr} impostata nel datepicker.`);
                                     } else {
                                         // Fallback if flatpickr instance not found
                                         console.warn("Istanza flatpickr non trovata, impostazione manuale fallback.");
                                         dateInput.value = dateStr;
                                         if(typeof updateDateIndicator === 'function') updateDateIndicator(parseDate(dateStr)); // Manually update indicator
                                         if(typeof loadExistingEntry === 'function') loadExistingEntry(dateStr); // Manually load entry
                                     }
                                     startTimeInput.focus(); // Focus on start time field
                                      // Scroll form into view
                                      const formElement = document.getElementById('timeEntryForm');
                                      if (formElement) {
                                          formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                      }
                                 } else {
                                      console.error("Input data o ora inizio non trovati dopo navigazione.");
                                 }
                                 modal.style.display = 'none'; // Close modal
                             }, 300); // Delay might need adjustment based on animation timing
                         } else {
                             console.error("Impossibile determinare la data (window.lastClickedDate) per aggiungere la voce.");
                             showToast("Errore: Impossibile determinare la data per aggiungere la voce.", "error");
                         }
                     });
                 } else { console.warn("Pulsante aggiungi voce nel modale non trovato."); }
             } else {
                 console.warn("Modale dettagli giorno non trovato.");
             }

            // Initial load for the default active section (Home)
            if (document.getElementById('home-section')?.classList.contains('active')) {
                 if (typeof loadTimeEntries === 'function') loadTimeEntries();
            }

             console.log("Inizializzazione interfaccia completata.");

        }); // End DOMContentLoaded

        // --- Core Data Functions ---

        function getDb() {
            try {
                const data = localStorage.getItem('timeTrackerData');
                // Ensure structure consistency on load
                const defaultDb = { entries: {}, settings: {}, holidays: {}, vehicles: [] };
                if (!data) return defaultDb;

                const parsedData = JSON.parse(data);
                // Merge with default to ensure all keys exist
                return {
                    entries: parsedData.entries || {},
                    settings: parsedData.settings || {},
                    holidays: parsedData.holidays || {},
                    vehicles: Array.isArray(parsedData.vehicles) ? parsedData.vehicles : []
                };
            } catch (e) {
                console.error("Error reading from localStorage:", e);
                showToast("Errore nel caricamento dei dati. Prova a cancellare i dati.", "error", 5000);
                return { entries: {}, settings: {}, holidays: {}, vehicles: [] }; // Return default structure on error
            }
        }

        function saveDb(db) {
             try {
                localStorage.setItem('timeTrackerData', JSON.stringify(db));
             } catch (e) {
                  console.error("Error saving to localStorage:", e);
                  // Check for QuotaExceededError specifically
                  if (e.name === 'QuotaExceededError') {
                      showToast("Errore: Spazio di archiviazione locale esaurito!", "error", 7000);
                  } else {
                      showToast("Errore nel salvataggio dei dati.", "error", 5000);
                  }
             }
        }

        // --- Time Entry Functions ---

        function saveTimeEntry(event) {
            event.preventDefault();
            console.log("Tentativo di salvataggio voce...");
            const db = getDb();
            const dateInput = document.getElementById('date');
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');
            const breakTimeInput = document.getElementById('breakTime');
            const notturneInput = document.getElementById('notturne');
            const transfertaInput = document.getElementById('transferta');
            const descriptionInput = document.getElementById('description');
            const totalHoursInput = document.getElementById('totalHours');
            const vehicleSelect = document.getElementById('vehicleSelect');
            const form = document.getElementById('timeEntryForm');

            // Validate elements exist
             if (!dateInput || !startTimeInput || !endTimeInput || !breakTimeInput || !notturneInput || !transfertaInput || !descriptionInput || !totalHoursInput || !vehicleSelect || !form) {
                 console.error("Uno o più elementi del form non trovati!");
                 showToast("Errore interno: Elementi del form mancanti.", "error");
                 return;
             }

            const date = dateInput.value;
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;
            const breakTime = parseFloat(breakTimeInput.value) || 0;
            const notturne = parseFloat(notturneInput.value) || 0;
            const transferta = parseFloat(transfertaInput.value) || 0;
            const description = descriptionInput.value.trim();
            const totalHours = parseFloat(totalHoursInput.value) || 0;
            const selectedVehicle = vehicleSelect.value; // Get selected vehicle ID or name

             // Basic validation
             if (!date || !startTime || !endTime) {
                 showToast("Data, Ora Inizio e Ora Fine sono obbligatori.", "error");
                 return;
             }
              // Allow 0 hours only if start/end are explicitly 0 (e.g., placeholder for non-work day info?)
              // Or maybe disallow 0 hours completely? Let's disallow for now.
             if (totalHours <= 0) {
                  showToast("Le ore totali calcolate devono essere maggiori di zero.", "error");
                  return;
              }
              if (notturne < 0 || transferta < 0 || breakTime < 0) {
                   showToast("Ore notturne, trasferta e pausa non possono essere negative.", "error");
                  return;
              }


            const entryId = form.dataset.editingId || Date.now().toString();
            const isEditing = !!form.dataset.editingId;
            const newEntry = {
                id: entryId,
                startTime,
                endTime,
                breakTime,
                notturne,
                transferta,
                description,
                totalHours,
                vehicle: selectedVehicle, // Save selected vehicle
                 lastModified: new Date().toISOString() // Track last edit
            };

            if (!db.entries[date]) {
                db.entries[date] = [];
            }

             // Check if editing or adding
             const existingEntryIndex = db.entries[date].findIndex(entry => entry.id === entryId);
             if (isEditing && existingEntryIndex > -1) {
                 // Update existing entry
                 db.entries[date][existingEntryIndex] = newEntry;
                 showToast('Voce aggiornata!', 'success');
                 console.log(`Voce aggiornata per ${date}, ID: ${entryId}`);
             } else if (!isEditing) {
                 // Add new entry
                 // Check if an entry with the same start/end time already exists for the day (prevent accidental duplicates)
                 const duplicateExists = db.entries[date].some(e => e.startTime === startTime && e.endTime === endTime);
                 if (duplicateExists) {
                     if (!confirm(`Sembra esistere già una voce con orario ${startTime}-${endTime} per il ${date}. Salvare comunque?`)) {
                         showToast("Salvataggio annullato.", "info");
                         return;
                     }
                 }
                 db.entries[date].push(newEntry);
                 showToast('Voce salvata!', 'success');
                 console.log(`Nuova voce salvata per ${date}, ID: ${entryId}`);
             } else if (isEditing && existingEntryIndex === -1) {
                  // Was in edit mode, but original entry not found? Treat as new entry.
                  console.warn(`Tentativo di aggiornare voce ${entryId} non trovata per data ${date}. Aggiunta come nuova.`);
                  db.entries[date].push(newEntry);
                  showToast('Voce salvata come nuova (originale non trovata).', 'success');
             }


            saveDb(db);

            // Reload relevant views if functions exist
            if (typeof loadTimeEntries === 'function') loadTimeEntries();
            if (document.getElementById('calendar-section')?.classList.contains('active') && typeof loadCalendarData === 'function') {
                loadCalendarData(); // Reload calendar data only if it's the active view
            }
             if (document.getElementById('monthly-report-section')?.classList.contains('active') && typeof displayMonthlyReport === 'function') {
                 const monthSelect = document.getElementById('exportMonthSelect');
                 if (monthSelect) displayMonthlyReport(monthSelect.value, document.getElementById('monthlyReportContent')); // Reload report if active
             }

            resetForm();
        }

        function loadTimeEntries(limit = 10) {
            const entriesContainer = document.getElementById('timeEntries');
            if (!entriesContainer) {
                console.warn("Contenitore 'timeEntries' non trovato per caricare le voci.");
                return;
            }
            console.log(`Caricamento ultime ${limit} voci...`);
            const db = getDb();
            entriesContainer.innerHTML = ''; // Clear previous entries

            // Flatten entries and sort by date descending, then by lastModified descending
            const allEntries = Object.entries(db.entries)
                .flatMap(([date, entriesOnDate]) =>
                    entriesOnDate.map(entry => ({ ...entry, date })) // Add date to each entry object
                )
                .sort((a, b) => {
                    // Prioritize date, then modification time
                    const dateA = parseDate(a.date).getTime();
                    const dateB = parseDate(b.date).getTime();
                    if (dateB !== dateA) return dateB - dateA; // Most recent date first

                    // If same date, sort by modification time (most recent first)
                    // Use entry ID (timestamp) as fallback if lastModified is missing
                    const timeA = a.lastModified ? new Date(a.lastModified).getTime() : parseInt(a.id);
                    const timeB = b.lastModified ? new Date(b.lastModified).getTime() : parseInt(b.id);
                    return timeB - timeA;
                });

            const recentEntries = allEntries.slice(0, limit);

            if (recentEntries.length === 0) {
                entriesContainer.innerHTML = '<p style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: 1rem;">Nessuna voce recente.</p>';
                console.log("Nessuna voce recente trovata.");
                return;
            }

            recentEntries.forEach(entry => {
                // Ensure createTimeEntryElement function exists and handles errors
                if (typeof createTimeEntryElement === 'function') {
                    try {
                        const entryElement = createTimeEntryElement(entry.date, entry);
                        if (entryElement) { // Check if the function returned a valid element
                             entriesContainer.appendChild(entryElement);
                        } else {
                             console.error(`createTimeEntryElement ha restituito null per la voce:`, entry);
                        }
                    } catch (error) {
                        console.error(`Errore nella creazione dell'elemento per la voce ${entry.id} del ${entry.date}:`, error);
                        // Optionally display an error placeholder in the list
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'time-entry';
                        errorDiv.innerHTML = `<div class='time-entry-info' style='color: var(--md-sys-color-error);'>Errore nel caricamento di questa voce.</div>`;
                        entriesContainer.appendChild(errorDiv);
                    }
                } else {
                     console.error("Funzione createTimeEntryElement non definita!");
                     // Stop processing further entries if critical function is missing
                     return;
                }
            });
             console.log(`${recentEntries.length} voci caricate.`);
        }

        function createTimeEntryElement(date, entry) {
            // Validate input
            if (!date || !entry || !entry.id) {
                console.error("createTimeEntryElement: Dati di input non validi.", { date, entry });
                return null; // Return null if data is invalid
            }

             const div = document.createElement('div');
             div.className = 'time-entry';
             div.dataset.id = entry.id;
             div.dataset.date = date;

             let vehicleName = '';
             if (typeof getVehicleNameById === 'function') {
                 vehicleName = getVehicleNameById(entry.vehicle);
             } else {
                  console.warn("Funzione getVehicleNameById non definita.");
             }


             // Build HTML safely
             const totalHoursText = typeof entry.totalHours === 'number' ? `${entry.totalHours.toFixed(1)}h` : 'N/A';
             const startTimeText = entry.startTime || 'N/A';
             const endTimeText = entry.endTime || 'N/A';
             const breakTimeText = typeof entry.breakTime === 'number' ? `${entry.breakTime.toFixed(1)}h` : 'N/A';

             let detailsHtml = `<span><span class="material-symbols-outlined">schedule</span> ${startTimeText} - ${endTimeText}</span>
                              <span><span class="material-symbols-outlined">pause_circle</span> Pausa: ${breakTimeText}</span>`;
             if (typeof entry.transferta === 'number' && entry.transferta > 0) {
                 detailsHtml += `<span><span class="material-symbols-outlined">local_shipping</span> Trasferta: ${entry.transferta.toFixed(1)}h</span>`;
             }
             if (typeof entry.notturne === 'number' && entry.notturne > 0) {
                 detailsHtml += `<span><span class="material-symbols-outlined">dark_mode</span> Notturne: ${entry.notturne.toFixed(1)}h</span>`;
             }

             const descriptionHtml = entry.description ? `<p class="time-entry-description">${escapeHtml(entry.description)}</p>` : '';
             const vehicleHtml = vehicleName ? `<p class="day-entry-vehicle"><span class="material-symbols-outlined">directions_car</span> ${escapeHtml(vehicleName)}</p>` : '';

             div.innerHTML = `
                 <div class="time-entry-info">
                     <div class="time-entry-header">
                         <span class="time-entry-date">${formatDate(date)}</span>
                         <span class="time-entry-hours">${totalHoursText}</span>
                     </div>
                     <div class="time-entry-details">
                         ${detailsHtml}
                     </div>
                     ${descriptionHtml}
                     ${vehicleHtml}
                 </div>
                 <div class="entry-buttons">
                     <button class="edit-btn" title="Modifica Voce" onclick="editEntry('${date}', '${entry.id}')">
                         <span class="material-symbols-outlined">edit</span>
                     </button>
                     <button class="delete-btn" title="Elimina Voce" onclick="deleteEntry('${date}', '${entry.id}')">
                          <span class="material-symbols-outlined">delete</span>
                     </button>
                 </div>
             `;
             return div;
         }


         function loadExistingEntry(date) {
             console.log(`Caricamento voce esistente per ${date}...`);
             const db = getDb();
             const entries = db.entries[date] || [];
             const form = document.getElementById('timeEntryForm');
             const submitBtn = document.getElementById('submitBtn');

             if (!form || !submitBtn) {
                  console.error("Form o pulsante submit non trovati per loadExistingEntry.");
                  return;
             }

             if (entries.length > 0) {
                 // Load the *last* entry for the day if multiple exist.
                 const entryToLoad = entries[entries.length - 1];
                 console.log("Trovata voce da caricare:", entryToLoad);

                 form.elements.startTime.value = entryToLoad.startTime || '';
                 form.elements.endTime.value = entryToLoad.endTime || '';
                 form.elements.breakTime.value = entryToLoad.breakTime ?? 0.5; // Default to 0.5 if undefined
                 form.elements.notturne.value = entryToLoad.notturne || '';
                 form.elements.transferta.value = entryToLoad.transferta || '';
                 form.elements.description.value = entryToLoad.description || '';
                 form.elements.totalHours.value = entryToLoad.totalHours || '';
                 form.elements.vehicleSelect.value = entryToLoad.vehicle || ""; // Set vehicle

                 form.dataset.editingId = entryToLoad.id; // Set editing ID
                 submitBtn.innerHTML = '<span class="material-symbols-outlined">update</span> Aggiorna';
             } else {
                 console.log(`Nessuna voce trovata per ${date}, reset parziale del form.`);
                 // Reset form fields but keep the date
                 resetForm(false); // false = Don't reset date
             }
             // Recalculate hours after loading/resetting
             calculateTotalHours();
         }

         function editEntry(date, entryId) {
             console.log(`Tentativo di modifica voce ${entryId} del ${date}`);
             const db = getDb();
             const entry = db.entries[date]?.find(e => e.id === entryId);
             const form = document.getElementById('timeEntryForm');
             const submitBtn = document.getElementById('submitBtn');
             const dateInput = document.getElementById('date');

             if (!form || !submitBtn || !dateInput) {
                 console.error("Elementi form mancanti per editEntry.");
                 showToast("Errore interno: Impossibile caricare la voce per la modifica.", "error");
                 return;
             }

             if (entry) {
                 console.log("Voce trovata, caricamento nel form:", entry);
                 // Set date in flatpickr first *without* triggering onChange
                 if (dateInput._flatpickr) {
                     dateInput._flatpickr.setDate(date, false);
                 } else {
                      dateInput.value = date; // Fallback
                 }
                 // Manually update the visual indicator as onChange wasn't triggered
                 if (typeof updateDateIndicator === 'function') {
                     updateDateIndicator(parseDate(date));
                 }


                 // Populate form fields
                 form.elements.startTime.value = entry.startTime || '';
                 form.elements.endTime.value = entry.endTime || '';
                 form.elements.breakTime.value = entry.breakTime ?? 0.5;
                 form.elements.notturne.value = entry.notturne || '';
                 form.elements.transferta.value = entry.transferta || '';
                 form.elements.description.value = entry.description || '';
                 form.elements.totalHours.value = entry.totalHours || '';
                 form.elements.vehicleSelect.value = entry.vehicle || "";

                 form.dataset.editingId = entry.id; // Mark as editing this specific entry
                 submitBtn.innerHTML = '<span class="material-symbols-outlined">update</span> Aggiorna';

                  // Ensure the home section is active and scroll to form
                  const homeNavItem = document.querySelector('.nav-item[data-section="home-section"]');
                  if (homeNavItem && !homeNavItem.classList.contains('active')) {
                      homeNavItem.click(); // Navigate if not already there
                  }
                  // Scroll into view after a short delay for section switch
                 setTimeout(() => {
                     form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                     form.elements.startTime.focus(); // Focus first editable field
                 }, 150);


             } else {
                 console.error(`Voce ${entryId} non trovata per la data ${date}.`);
                 showToast("Voce non trovata.", "error");
                 resetForm(); // Reset form if entry not found
             }
         }

         function deleteEntry(date, entryId) {
             console.log(`Tentativo di eliminazione voce ${entryId} del ${date}`);
             if (confirm(`Sei sicuro di voler eliminare questa voce del ${date}?`)) {
                 const db = getDb();
                 let entryDeleted = false;
                 if (db.entries[date]) {
                     const initialLength = db.entries[date].length;
                     db.entries[date] = db.entries[date].filter(entry => entry.id !== entryId);
                     if (db.entries[date].length < initialLength) {
                         entryDeleted = true;
                         console.log(`Voce ${entryId} eliminata.`);
                     }
                     // If no entries left for this date, remove the date key entirely
                     if (db.entries[date].length === 0) {
                         delete db.entries[date];
                         console.log(`Array voci per ${date} rimosso perché vuoto.`);
                     }
                     saveDb(db);
                     showToast('Voce eliminata.', 'success');
                     // Reload relevant views
                     if (typeof loadTimeEntries === 'function') loadTimeEntries();
                     if (document.getElementById('calendar-section')?.classList.contains('active') && typeof loadCalendarData === 'function') loadCalendarData();
                     if (document.getElementById('monthly-report-section')?.classList.contains('active') && typeof displayMonthlyReport === 'function') {
                          const monthSelect = document.getElementById('exportMonthSelect');
                          if (monthSelect) displayMonthlyReport(monthSelect.value, document.getElementById('monthlyReportContent'));
                     }
                      // If the deleted entry was being edited, reset the form
                      const form = document.getElementById('timeEntryForm');
                      if (form && form.dataset.editingId === entryId) {
                          resetForm(false); // Reset form but keep date
                      }

                 } else {
                      console.warn(`Nessuna voce trovata per la data ${date} durante l'eliminazione.`);
                       showToast('Voce non trovata (potrebbe essere già stata eliminata).', 'warning');
                 }

             } else {
                  console.log("Eliminazione annullata dall'utente.");
             }
         }

        function resetForm(resetDate = true) {
            console.log(`Reset form requested. Reset date: ${resetDate}`);
            const form = document.getElementById('timeEntryForm');
             if (!form) {
                 console.error("Form non trovato per il reset.");
                 return;
             }

             const dateInput = document.getElementById('date');
             const totalHoursInput = document.getElementById('totalHours');
             const submitBtn = document.getElementById('submitBtn');

             // Store current date before reset if needed
             const currentDateValue = dateInput ? dateInput.value : null;

             form.reset(); // Resets native form elements to default values (e.g., breakTime to 0.5)

             // Explicitly clear fields that might not reset correctly or need specific handling
             if (document.getElementById('notturne')) document.getElementById('notturne').value = '';
             if (document.getElementById('transferta')) document.getElementById('transferta').value = '';
             if (document.getElementById('description')) document.getElementById('description').value = '';
             if (document.getElementById('vehicleSelect')) document.getElementById('vehicleSelect').value = ''; // Reset vehicle select
             if (totalHoursInput) totalHoursInput.value = ''; // Clear calculated hours

             delete form.dataset.editingId; // Remove editing state

             if (submitBtn) {
                 submitBtn.innerHTML = '<span class="material-symbols-outlined">save</span> Salva';
             }

             if (resetDate && dateInput) {
                 const today = new Date();
                 const dateStr = formatDateForInput(today);
                 if (dateInput._flatpickr) {
                     dateInput._flatpickr.setDate(dateStr, true); // Set to today and trigger update
                     console.log("Data reimpostata a oggi nel datepicker.");
                 } else {
                      dateInput.value = dateStr;
                     if(typeof updateDateIndicator === 'function') updateDateIndicator(today); // Manual update if no flatpickr
                     console.log("Data reimpostata a oggi (fallback).");
                 }
             } else if (!resetDate && dateInput && currentDateValue) {
                  // Restore the original date if we didn't reset it
                  if (dateInput._flatpickr) {
                     dateInput._flatpickr.setDate(currentDateValue, false); // Restore without triggering change
                  } else {
                      dateInput.value = currentDateValue;
                  }
                  // Manually update indicator since onChange wasn't triggered
                  if(typeof updateDateIndicator === 'function') updateDateIndicator(parseDate(currentDateValue));
                   console.log(`Data ${currentDateValue} mantenuta dopo reset parziale.`);
             }


             // Recalculate hours (should be 0 or based on default break)
             calculateTotalHours();

             // Focus first field (optional)
             const startTimeInput = document.getElementById('startTime');
             if (startTimeInput) {
                 // startTimeInput.focus(); // Focus might be annoying, comment out for now
             }

             console.log("Form resettato.");
         }


        // --- Calendar Functions ---

        function loadCalendarData(targetDate = null) {
             const calendarContainer = document.getElementById('calendarEntries');
             const monthlySummaryContainer = document.getElementById('monthlySummary');
             const calendarSection = document.getElementById('calendar-section');

             // Only render if the calendar section is active
             if (!calendarSection || !calendarSection.classList.contains('active')) {
                 console.log("Skipping calendar render: section not active.");
                 return;
             }

             if (!calendarContainer || !monthlySummaryContainer) {
                 console.error("Elementi del calendario (#calendarEntries) o del riepilogo mensile (#monthlySummary) non trovati.");
                 return;
             }
             console.log("Rendering calendar...");

             const db = getDb();
             // Determine the date to display: use targetDate if provided, else current view, else today
             let dateToDisplay;
             if (targetDate) {
                 dateToDisplay = parseDate(targetDate);
                 if (isNaN(dateToDisplay.getTime())) { // Handle invalid targetDate
                     console.warn(`Data target non valida (${targetDate}), uso data corrente o oggi.`);
                     dateToDisplay = window.currentCalendarDate || new Date();
                 }
             } else {
                 dateToDisplay = window.currentCalendarDate || new Date();
             }
              if (isNaN(dateToDisplay.getTime())) { // Final fallback if stored date is invalid
                    dateToDisplay = new Date();
              }

             window.currentCalendarDate = dateToDisplay; // Store current view date

             const year = dateToDisplay.getFullYear();
             const month = dateToDisplay.getMonth(); // 0-indexed

             try {
                calendarContainer.innerHTML = generateCalendarHTML(year, month, db);
                updateMonthlySummary(year, month, db);
                // Add event listeners after generating HTML
                attachCalendarEventListeners();
                 console.log(`Calendario generato per ${month + 1}/${year}`);
             } catch (error) {
                  console.error(`Errore durante la generazione del calendario per ${month + 1}/${year}:`, error);
                  calendarContainer.innerHTML = `<p style='color: var(--md-sys-color-error); text-align: center; padding: 1rem;'>Errore nella generazione del calendario.</p>`;
             }
         }

         function generateCalendarHTML(year, month, db) {
             const firstDayOfMonth = new Date(year, month, 1);
             const lastDayOfMonth = new Date(year, month + 1, 0);
             const daysInMonth = lastDayOfMonth.getDate();
             let startingDay = firstDayOfMonth.getDay(); // 0 (Sun) to 6 (Sat)
             startingDay = startingDay === 0 ? 6 : startingDay - 1; // Adjust to Mon (0) to Sun (6)

             const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
             const dayNames = ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"];

             let html = `<div class="calendar-header">
                         <button onclick="changeMonth(-1)" title="Mese Precedente"><span class="material-symbols-outlined">chevron_left</span></button>
                         <div class="calendar-title">
                             <span class="calendar-month">${monthNames[month]}</span>
                             <span class="calendar-year">${year}</span>
                         </div>
                         <button onclick="changeMonth(1)" title="Mese Successivo"><span class="material-symbols-outlined">chevron_right</span></button>
                       </div>`;
             html += `<div class="calendar-grid">`;

             // Weekday Headers
             dayNames.forEach(day => {
                 html += `<div class="calendar-weekday">${day}</div>`;
             });

             // Empty cells before the start of the month
             for (let i = 0; i < startingDay; i++) {
                 html += `<div class="calendar-day empty"></div>`;
             }

             // Days of the month
             const today = new Date();
             const todayStr = formatDateForInput(today);

             for (let day = 1; day <= daysInMonth; day++) {
                 const date = new Date(year, month, day);
                 const dateStr = formatDateForInput(date);
                 const entries = db.entries[dateStr] || [];
                 const holidayInfo = db.holidays[dateStr]; // Check ferie/malattie first
                 const isWeekend = date.getDay() === 0 || date.getDay() === 6; // Sunday or Saturday
                 const isStdHoliday = !holidayInfo && isItalianHoliday(date); // Check standard holiday if not ferie/malattia
                 const holidayName = holidayInfo ? (holidayInfo.note || (holidayInfo.type === 'ferie' ? 'Ferie' : 'Malattia')) : (isStdHoliday ? getHolidayName(date) : '');


                 let dayClasses = 'calendar-day';
                 if (dateStr === todayStr) dayClasses += ' today';
                 if (entries.length > 0) dayClasses += ' has-entries';
                  if (holidayInfo) dayClasses += ` ${holidayInfo.type}`; // 'ferie' or 'malattia' class
                 else if (isStdHoliday) dayClasses += ' holiday';
                 // Add weekend class? Optional for styling.
                 // if (isWeekend) dayClasses += ' weekend';

                 let totalHours = 0;
                 let hasTransferta = false;
                 let hasNotturne = false;
                 let hasVehicle = false;
                 entries.forEach(e => {
                     // Ensure totalHours is a number before adding
                     totalHours += (typeof e.totalHours === 'number' ? e.totalHours : 0);
                     if (e.transferta > 0) hasTransferta = true;
                     if (e.notturne > 0) hasNotturne = true;
                     if (e.vehicle) hasVehicle = true;
                 });

                 // Determine title attribute for hover info
                 let title = `${day} ${monthNames[month]} ${year}`;
                 if(holidayInfo) title += ` - ${holidayInfo.type === 'ferie' ? 'Ferie' : 'Malattia'}${holidayInfo.note ? ': ' + holidayInfo.note : ''}`;
                 else if(isStdHoliday) title += ` - ${holidayName}`;
                 else if(entries.length > 0) title += ` - Lavorato: ${totalHours.toFixed(1)}h`;


                 html += `<div class="${dayClasses}" data-date="${dateStr}" title="${escapeHtml(title)}">`; // Add title attribute
                 html += `<span class="calendar-day-number">${day}</span>`;
                 html += `<div class="calendar-day-content">`;

                  if (holidayInfo) {
                     // Show Ferie/Malattia icon and optional note
                     const icon = holidayInfo.type === 'ferie' ? 'beach_access' : 'sick';
                     html += `<span class="calendar-icons"><span class="material-symbols-outlined">${icon}</span></span>`;
                      if (holidayInfo.note) {
                          html += `<span class="calendar-holiday-name">${escapeHtml(holidayInfo.note)}</span>`;
                      } else {
                           html += `<span class="calendar-holiday-name">${holidayInfo.type === 'ferie' ? 'Ferie' : 'Malattia'}</span>`;
                      }
                  } else if (entries.length > 0) {
                     // Show work details
                      if (totalHours > 0) { // Only show hours if positive
                        html += `<span class="calendar-hours">${totalHours.toFixed(1)}h</span>`;
                      }
                     html += `<div class="calendar-icons">`;
                     if (hasTransferta) html += `<span class="material-symbols-outlined" title="Trasferta">local_shipping</span>`;
                     if (hasNotturne) html += `<span class="material-symbols-outlined" title="Notturne">dark_mode</span>`;
                     if (hasVehicle) html += `<span class="material-symbols-outlined" title="Mezzo utilizzato">directions_car</span>`;
                      // Add placeholder if icons are empty but hours exist? Optional.
                      // if (!hasTransferta && !hasNotturne && !hasVehicle && totalHours > 0) html += `<span>&nbsp;</span>`;
                     html += `</div>`;
                 } else if (isStdHoliday) {
                     // Show standard holiday name
                     html += `<span class="calendar-holiday-name">${escapeHtml(holidayName)}</span>`;
                 } else {
                      // Empty workday or weekend - maybe add a subtle indicator?
                      // html += `<span style="opacity: 0.5;">-</span>`
                 }

                 html += `</div>`; // end content
                 html += `</div>`; // end day
             }

             // Empty cells after the end of the month
             const totalCells = startingDay + daysInMonth;
             const remainingCells = (7 - (totalCells % 7)) % 7;
             for (let i = 0; i < remainingCells; i++) {
                 html += `<div class="calendar-day empty"></div>`;
             }

             html += `</div>`; // end grid
             return html;
         }

        function updateMonthlySummary(year, month, db) {
            const monthlyTotalHoursEl = document.getElementById('monthlyTotalHours');
            const monthlyWorkDaysEl = document.getElementById('monthlyWorkDays');
            const monthlyTransfertaEl = document.getElementById('monthlyTransferta');
            const monthlyNotturneEl = document.getElementById('monthlyNotturne');

            if (!monthlyTotalHoursEl || !monthlyWorkDaysEl || !monthlyTransfertaEl || !monthlyNotturneEl) {
                console.warn("Uno o più elementi del riepilogo mensile del calendario non trovati.");
                return;
            }

            let totalHours = 0;
            let workDays = 0;
            let totalTransferta = 0;
            let totalNotturne = 0;

            // Iterate through dates of the specified month
             const daysInMonth = new Date(year, month + 1, 0).getDate();
             for (let day = 1; day <= daysInMonth; day++) {
                 const date = new Date(year, month, day);
                 const dateStr = formatDateForInput(date);
                 const entries = db.entries[dateStr] || [];
                 const isAbsence = !!db.holidays[dateStr]; // Check if it's a holiday/sick day

                 if (!isAbsence && entries.length > 0) { // Only count work days
                     let dayHasHours = false;
                     entries.forEach(entry => {
                         totalHours += (typeof entry.totalHours === 'number' ? entry.totalHours : 0);
                         totalTransferta += (typeof entry.transferta === 'number' ? entry.transferta : 0);
                         totalNotturne += (typeof entry.notturne === 'number' ? entry.notturne : 0);
                         if (typeof entry.totalHours === 'number' && entry.totalHours > 0) {
                             dayHasHours = true;
                         }
                     });
                     if (dayHasHours) {
                         workDays++;
                     }
                 }
            }


             // Update summary display
             monthlyTotalHoursEl.textContent = `${totalHours.toFixed(1)}h`;
             monthlyWorkDaysEl.textContent = workDays;
             monthlyTransfertaEl.textContent = `${totalTransferta.toFixed(1)}h`;
             monthlyNotturneEl.textContent = `${totalNotturne.toFixed(1)}h`;
             console.log(`Riepilogo mensile calendario aggiornato per ${month + 1}/${year}: Lavorati=${workDays}, Ore=${totalHours.toFixed(1)}`);
        }


         function changeMonth(delta) {
             if (!window.currentCalendarDate) window.currentCalendarDate = new Date();
             // Ensure we have a valid date before changing month
             if (isNaN(window.currentCalendarDate.getTime())) window.currentCalendarDate = new Date();

             window.currentCalendarDate.setDate(1); // Go to the 1st to avoid month skipping issues
             window.currentCalendarDate.setMonth(window.currentCalendarDate.getMonth() + delta);
             console.log(`Cambio mese a: ${window.currentCalendarDate.toLocaleDateString()}`);
             loadCalendarData(formatDateForInput(window.currentCalendarDate)); // Reload with new date
         }

         function attachCalendarEventListeners() {
             const days = document.querySelectorAll('#calendarEntries .calendar-day:not(.empty)');
             if (days.length === 0) {
                 console.log("Nessun giorno cliccabile trovato nel calendario per aggiungere event listener.");
                 return;
             }
             let clickCount = 0;
             days.forEach(day => {
                 // Remove previous listener if any? Maybe not necessary if grid is regenerated.
                 day.addEventListener('click', () => {
                     const dateStr = day.getAttribute('data-date');
                     if (dateStr && typeof openDayModal === 'function') {
                          console.log(`Click sul giorno: ${dateStr}`);
                         openDayModal(dateStr);
                         clickCount++;
                     } else {
                          console.warn("Attributo data mancante o funzione openDayModal non definita.");
                     }
                 });
             });
              console.log(`Aggiunti event listener a ${days.length} giorni del calendario. Click registrati finora: ${clickCount}`);
         }

        // --- Modal Functions ---

        function openDayModal(dateStr) {
            const modal = document.getElementById('dayModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalTotalHours = document.getElementById('modalTotalHours');
            const modalTransferta = document.getElementById('modalTransferta');
            const modalNotturne = document.getElementById('modalNotturne');
            const modalEntries = document.getElementById('modalEntries');
            const daySummary = modal ? modal.querySelector('.day-summary') : null;
            const addEntryModalBtn = modal ? modal.querySelector('#addEntryBtn') : null;


            if (!modal || !modalTitle || !modalTotalHours || !modalTransferta || !modalNotturne || !modalEntries || !daySummary || !addEntryModalBtn) {
                console.error("Uno o più elementi del modale non trovati:", { modal, modalTitle, modalTotalHours, modalTransferta, modalNotturne, modalEntries, daySummary, addEntryModalBtn });
                showToast("Errore: Impossibile aprire i dettagli del giorno.", "error");
                return;
            }

            console.log(`Apertura modale per ${dateStr}`);
            const db = getDb();
            const date = parseDate(dateStr);
             if (isNaN(date.getTime())) {
                 console.error(`Data non valida (${dateStr}) per aprire il modale.`);
                  showToast("Errore: Data non valida.", "error");
                 return;
             }
             window.lastClickedDate = dateStr; // Store for "Add Entry" button

            modalTitle.textContent = `Dettagli ${date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}`;
            modalEntries.innerHTML = ''; // Clear previous entries

            const entries = db.entries[dateStr] || [];
            const holidayInfo = db.holidays[dateStr];

            let totalHours = 0;
            let totalTransferta = 0;
            let totalNotturne = 0;

            // Reset visibility states
            daySummary.style.display = 'grid'; // Show summary by default
            addEntryModalBtn.style.display = 'inline-flex'; // Show Add button by default

            if (holidayInfo) {
                 // --- Display Ferie/Malattia Info ---
                 console.log(`Giorno ${dateStr} è ${holidayInfo.type}`);
                 const typeText = holidayInfo.type === 'ferie' ? 'Ferie' : 'Malattia';
                 const icon = holidayInfo.type === 'ferie' ? 'beach_access' : 'sick';
                 modalEntries.innerHTML = `
                     <div style="text-align: center; padding: 1rem; background-color: ${holidayInfo.type === 'ferie' ? 'var(--md-sys-color-tertiary-container)' : 'var(--md-sys-color-secondary-container)'} ; border-radius: var(--border-radius-medium); color: ${holidayInfo.type === 'ferie' ? 'var(--md-sys-color-on-tertiary-container)' : 'var(--md-sys-color-on-secondary-container)'};">
                         <span class="material-symbols-outlined" style="font-size: 2rem; vertical-align: middle; margin-right: 0.5rem;">${icon}</span>
                         <strong style="font-size: 1.1rem;">${typeText}</strong>
                         ${holidayInfo.note ? `<p style="margin-top: 0.5rem; font-style: italic;">${escapeHtml(holidayInfo.note)}</p>` : ''}
                          <button class="delete-btn" style="margin-top: 1rem; background-color: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container);" onclick="deleteFerieMalattieEntryFromModal('${dateStr}')">
                             <span class="material-symbols-outlined">delete</span> Elimina ${typeText}
                         </button>
                     </div>`;
                 // Hide work summary and add button if it's a full day off
                 daySummary.style.display = 'none';
                 addEntryModalBtn.style.display = 'none';

            } else if (entries.length > 0) {
                 // --- Display Work Entries ---
                 console.log(`Trovate ${entries.length} voci di lavoro per ${dateStr}`);
                 daySummary.style.display = 'grid'; // Ensure visible
                 addEntryModalBtn.style.display = 'inline-flex'; // Ensure visible

                 entries.forEach(entry => {
                     totalHours += (typeof entry.totalHours === 'number' ? entry.totalHours : 0);
                     totalTransferta += (typeof entry.transferta === 'number' ? entry.transferta : 0);
                     totalNotturne += (typeof entry.notturne === 'number' ? entry.notturne : 0);

                     const entryDiv = document.createElement('div');
                     entryDiv.className = 'day-entry';
                     entryDiv.dataset.id = entry.id;
                     const vehicleName = getVehicleNameById(entry.vehicle);

                      // Safely build HTML parts
                      const hoursText = typeof entry.totalHours === 'number' ? `(${entry.totalHours.toFixed(1)}h)` : '(N/A)';
                      const timeRangeText = `${entry.startTime || '?'} - ${entry.endTime || '?'}`;
                      const breakText = typeof entry.breakTime === 'number' ? `${entry.breakTime.toFixed(1)}h` : '?h';
                      const transfertaDetail = (typeof entry.transferta === 'number' && entry.transferta > 0) ? `<span><span class="material-symbols-outlined">local_shipping</span> Trasferta: ${entry.transferta.toFixed(1)}h</span>` : '';
                      const notturneDetail = (typeof entry.notturne === 'number' && entry.notturne > 0) ? `<span><span class="material-symbols-outlined">dark_mode</span> Notturne: ${entry.notturne.toFixed(1)}h</span>` : '';
                      const descriptionDetail = entry.description ? `<p class="day-entry-description">${escapeHtml(entry.description)}</p>` : '';
                      const vehicleDetail = vehicleName ? `<p class="day-entry-vehicle"><span class="material-symbols-outlined">directions_car</span> ${escapeHtml(vehicleName)}</p>` : '';


                     entryDiv.innerHTML = `
                         <div class="day-entry-info">
                             <div class="day-entry-header">
                                  <span class="day-entry-hours">${timeRangeText} ${hoursText}</span>
                             </div>
                              <div class="day-entry-details">
                                 <span><span class="material-symbols-outlined">pause_circle</span> Pausa: ${breakText}</span>
                                 ${transfertaDetail}
                                 ${notturneDetail}
                             </div>
                              ${descriptionDetail}
                              ${vehicleDetail}
                         </div>
                         <div class="entry-buttons">
                             <button class="edit-btn" title="Modifica" onclick="editEntryFromModal('${dateStr}', '${entry.id}')">
                                 <span class="material-symbols-outlined">edit</span>
                             </button>
                             <button class="delete-btn" title="Elimina" onclick="deleteEntryFromModal('${dateStr}', '${entry.id}')">
                                 <span class="material-symbols-outlined">delete</span>
                             </button>
                         </div>
                     `;
                     modalEntries.appendChild(entryDiv);
                 });

                 modalTotalHours.textContent = `${totalHours.toFixed(1)}h`;
                 modalTransferta.textContent = `${totalTransferta.toFixed(1)}h`;
                 modalNotturne.textContent = `${totalNotturne.toFixed(1)}h`;

             } else {
                 // --- No entries and not a holiday ---
                  console.log(`Nessuna voce o assenza per ${dateStr}`);
                 daySummary.style.display = 'grid'; // Ensure summary is visible
                 addEntryModalBtn.style.display = 'inline-flex'; // Ensure add button is visible
                 modalEntries.innerHTML = '<p style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: 1rem;">Nessuna voce per questo giorno.</p>';
                 modalTotalHours.textContent = '0h';
                 modalTransferta.textContent = '0h';
                 modalNotturne.textContent = '0h';
             }


            modal.style.display = 'block';
        }

         // Function to handle editing directly from the modal
         function editEntryFromModal(dateStr, entryId) {
             console.log(`Modifica richiesta da modale per ${entryId} del ${dateStr}`);
             const modal = document.getElementById('dayModal');
             if(modal) modal.style.display = 'none'; // Close modal first
             editEntry(dateStr, entryId); // Call the main edit function
         }

        function deleteEntryFromModal(dateStr, entryId) {
             console.log(`Eliminazione richiesta da modale per ${entryId} del ${dateStr}`);
             if (confirm(`Sei sicuro di voler eliminare questa voce?`)) {
                 const db = getDb();
                 if (db.entries[dateStr]) {
                     db.entries[dateStr] = db.entries[dateStr].filter(entry => entry.id !== entryId);
                     if (db.entries[dateStr].length === 0) {
                         delete db.entries[dateStr];
                     }
                     saveDb(db);
                     showToast('Voce eliminata.', 'success');
                     openDayModal(dateStr); // Refresh modal content immediately
                     // Reload other views after modal refresh
                     if (typeof loadTimeEntries === 'function') loadTimeEntries();
                     if (typeof loadCalendarData === 'function') loadCalendarData(); // Reload calendar view needed if day state changes
                     if (document.getElementById('monthly-report-section')?.classList.contains('active') && typeof displayMonthlyReport === 'function') {
                          const monthSelect = document.getElementById('exportMonthSelect');
                          if (monthSelect) displayMonthlyReport(monthSelect.value, document.getElementById('monthlyReportContent'));
                     }
                 } else {
                      console.warn(`Nessuna voce trovata per ${dateStr} durante eliminazione da modale.`);
                      showToast("Voce non trovata (potrebbe essere già stata eliminata).", "warning");
                      const modal = document.getElementById('dayModal');
                      if (modal) modal.style.display = 'none'; // Close modal if entry list was likely wrong
                 }
             } else {
                  console.log("Eliminazione da modale annullata.");
             }
         }

        // Function to delete Ferie/Malattia entry from the modal
        function deleteFerieMalattieEntryFromModal(dateStr) {
             console.log(`Eliminazione Ferie/Malattia da modale per ${dateStr}`);
             if (confirm(`Sei sicuro di voler eliminare l'assenza (${db.holidays[dateStr]?.type || 'N/D'}) per il ${dateStr}?`)) {
                 const db = getDb();
                 if (db.holidays && db.holidays[dateStr]) {
                     delete db.holidays[dateStr];
                     saveDb(db);
                     showToast('Assenza eliminata.', 'success');
                     openDayModal(dateStr); // Refresh modal content
                     // Also refresh lists and calendar
                     if (typeof loadFerieMalattieEntries === 'function') loadFerieMalattieEntries();
                     if (typeof loadCalendarData === 'function') loadCalendarData();
                      if (document.getElementById('monthly-report-section')?.classList.contains('active') && typeof displayMonthlyReport === 'function') {
                          const monthSelect = document.getElementById('exportMonthSelect');
                          if (monthSelect) displayMonthlyReport(monthSelect.value, document.getElementById('monthlyReportContent'));
                     }
                 } else {
                      console.warn(`Nessuna assenza trovata per ${dateStr} per eliminazione da modale.`);
                      showToast("Assenza non trovata.", "warning");
                      const modal = document.getElementById('dayModal');
                      if (modal) modal.style.display = 'none';
                 }
             } else {
                 console.log("Eliminazione assenza da modale annullata.");
             }
         }


        // --- Settings Functions ---

        function exportData() {
             console.log("Esportazione dati richiesta...");
            try {
                 const db = getDb();
                 const userName = localStorage.getItem('userName') || 'Utente';
                 const filename = `Ore_${userName}_${new Date().toISOString().split('T')[0]}.json`;
                 const dataStr = JSON.stringify(db, null, 2); // Pretty print JSON
                 const dataBlob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });

                 // Use File System Access API if available (more robust)
                 if ('showSaveFilePicker' in window) {
                     window.showSaveFilePicker({
                         suggestedName: filename,
                         types: [{
                             description: 'JSON Files',
                             accept: { 'application/json': ['.json'] },
                         }],
                     }).then(handle => handle.createWritable())
                       .then(writable => {
                           writable.write(dataBlob).then(() => {
                               writable.close();
                               showToast('Dati esportati con successo!', 'success');
                               console.log("Dati esportati con showSaveFilePicker.");
                           });
                       }).catch(err => {
                             if (err.name !== 'AbortError') { // Ignore user cancellation
                                 console.error("Errore showSaveFilePicker:", err);
                                 showToast(`Errore esportazione: ${err.message}`, 'error');
                             } else {
                                 console.log("Esportazione annullata dall'utente.");
                             }
                       });
                 } else {
                     // Fallback using download link
                     const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                     const linkElement = document.createElement('a');
                     linkElement.setAttribute('href', dataUri);
                     linkElement.setAttribute('download', filename);
                     linkElement.style.display = 'none';
                     document.body.appendChild(linkElement);
                     linkElement.click();
                     document.body.removeChild(linkElement);
                     showToast('Download dati avviato.', 'success');
                      console.log("Dati esportati con link download (fallback).");
                 }
            } catch (error) {
                 console.error("Errore catastrofico durante l'esportazione:", error);
                 showToast("Errore grave durante l'esportazione dati.", "error");
            }
        }

         function triggerImport() {
             console.log("Importazione dati richiesta...");
             const fileInput = document.createElement('input');
             fileInput.type = 'file';
             fileInput.accept = '.json,application/json'; // Be explicit
             fileInput.style.display = 'none';

             fileInput.addEventListener('change', handleImportFile, { once: true }); // Use once

             document.body.appendChild(fileInput);
             fileInput.click();
             // No need to remove immediately, event listener will handle it
             // document.body.removeChild(fileInput); // Clean up input element later
         }

         function handleImportFile(event) {
             console.log("File selezionato per l'importazione.");
             const fileInput = event.target; // Get the input element itself
             const file = fileInput.files[0];

             if (!file) {
                 showToast('Nessun file selezionato.', 'warning');
                 if (fileInput.parentNode) fileInput.parentNode.removeChild(fileInput); // Cleanup
                 return;
             }
             console.log(`File selezionato: ${file.name}, tipo: ${file.type}, dimensione: ${file.size}`);

             // Basic type check
             if (file.type !== 'application/json' && !file.name.toLowerCase().endsWith('.json')) {
                  showToast('Tipo di file non supportato. Seleziona un file .json.', 'error');
                  if (fileInput.parentNode) fileInput.parentNode.removeChild(fileInput); // Cleanup
                  return;
             }


             const reader = new FileReader();
             reader.onload = function(e) {
                 console.log("File letto con successo.");
                 try {
                     const importedText = e.target.result;
                      if (!importedText) {
                          throw new Error("Il file sembra essere vuoto.");
                      }
                     const importedData = JSON.parse(importedText);

                     // --- Comprehensive validation of imported structure ---
                     if (typeof importedData !== 'object' || importedData === null) {
                         throw new Error("Il file JSON non contiene un oggetto valido.");
                     }

                      const expectedKeys = ['entries', 'settings', 'holidays', 'vehicles'];
                      const foundKeys = Object.keys(importedData);
                      const hasExpectedStructure = expectedKeys.some(key => foundKeys.includes(key));

                      if (!hasExpectedStructure) {
                          throw new Error("La struttura del file JSON non è compatibile (mancano 'entries', 'settings', 'holidays' o 'vehicles').");
                      }

                     // Further validation (optional but recommended)
                     if (importedData.entries && typeof importedData.entries !== 'object') throw new Error("La chiave 'entries' non è un oggetto.");
                     if (importedData.settings && typeof importedData.settings !== 'object') throw new Error("La chiave 'settings' non è un oggetto.");
                     if (importedData.holidays && typeof importedData.holidays !== 'object') throw new Error("La chiave 'holidays' non è un oggetto.");
                      if (importedData.vehicles && !Array.isArray(importedData.vehicles)) throw new Error("La chiave 'vehicles' non è un array.");
                      // Could add checks for internal structures too (e.g., format of entries)


                     // --- Confirmation ---
                     if (confirm("Importando questo file sovrascriverai TUTTI i dati attuali (ore, impostazioni, mezzi, assenze). Continuare?")) {
                         console.log("Importazione confermata dall'utente.");
                         // Merge settings smartly? For now, overwrite.
                         const currentDb = getDb(); // Get current structure for reference if needed
                         const mergedDb = {
                             entries: { ...(importedData.entries || {}) },
                             settings: { ...(importedData.settings || {}) },
                             holidays: { ...(importedData.holidays || {}) },
                             vehicles: [ ...(importedData.vehicles || []) ]
                         };

                         saveDb(mergedDb);
                         console.log("Dati importati e salvati in localStorage.");
                         showToast('Dati importati con successo! Ricaricamento...', 'success', 3000);
                         // Reload everything to reflect changes
                         setTimeout(() => window.location.reload(), 1500); // Reload page after import
                     } else {
                          console.log("Importazione annullata dall'utente.");
                          showToast("Importazione annullata.", "info");
                     }
                 } catch (error) {
                     console.error("Errore durante l'analisi o la validazione del JSON importato:", error);
                     showToast(`Errore nell'importazione: ${error.message}`, 'error', 7000);
                 } finally {
                      // Ensure cleanup even on error
                      if (fileInput.parentNode) fileInput.parentNode.removeChild(fileInput);
                 }
             };
             reader.onerror = function() {
                  console.error("Errore FileReader durante la lettura del file.");
                 showToast('Errore nella lettura del file.', 'error');
                 if (fileInput.parentNode) fileInput.parentNode.removeChild(fileInput); // Cleanup
             };
             reader.readAsText(file);
         }


        function clearAllData() {
             console.log("Richiesta cancellazione dati.");
            // Double confirmation
            if (confirm("SEI SICURO di voler cancellare TUTTI i dati inseriti (ore, impostazioni, mezzi, assenze)? Questa azione è IRREVERSIBILE!")) {
                 if (confirm("ULTIMA CONFERMA: Vuoi davvero cancellare TUTTI i dati salvati in questa applicazione?")) {
                    console.log("Cancellazione confermata. Rimuovo dati...");
                    localStorage.removeItem('timeTrackerData');
                    localStorage.removeItem('userName'); // Also clear user name
                    console.log("Dati rimossi da localStorage.");
                    showToast('Tutti i dati sono stati cancellati. Ricaricamento...', 'success', 4000);
                     // Reload page to clear state completely
                     setTimeout(() => window.location.reload(), 1500);
                 } else {
                      console.log("Seconda conferma cancellazione fallita.");
                      showToast("Cancellazione annullata.", "info");
                 }
            } else {
                 console.log("Prima conferma cancellazione fallita.");
                 showToast("Cancellazione annullata.", "info");
            }
        }


         // --- Vehicle Functions ---
        const MAX_VEHICLES = 10;

        function loadVehicles() {
            const vehiclesListContainer = document.getElementById('vehiclesList');
            const vehicleSelect = document.getElementById('vehicleSelect');
            // Only proceed if necessary elements exist
             if (!vehiclesListContainer && !vehicleSelect) {
                  console.log("Nessun elemento per la gestione mezzi trovato (lista o select). Skip caricamento.");
                 return;
             }

            console.log("Caricamento mezzi...");
            const db = getDb();
            const vehicles = db.vehicles || []; // Ensure vehicles is an array

            // Populate list in settings
            if (vehiclesListContainer) {
                vehiclesListContainer.innerHTML = ''; // Clear list
                if (vehicles.length === 0) {
                     vehiclesListContainer.innerHTML = '<p style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: 1rem 0;">Nessun mezzo aggiunto.</p>';
                     console.log("Nessun mezzo da visualizzare nella lista impostazioni.");
                } else {
                     console.log(`Visualizzazione ${vehicles.length} mezzi nella lista impostazioni.`);
                     vehicles.forEach(vehicle => {
                         if (!vehicle || !vehicle.id || !vehicle.name) {
                              console.warn("Trovato mezzo non valido, skippato:", vehicle);
                              return; // Skip invalid vehicle entries
                         }
                         const item = document.createElement('div');
                         item.className = 'vehicle-item';
                         item.innerHTML = `
                             <div class="vehicle-info">
                                 <span class="vehicle-name">${escapeHtml(vehicle.name)}</span>
                                 ${vehicle.plate ? `<span class="vehicle-plate">${escapeHtml(vehicle.plate)}</span>` : ''}
                             </div>
                             <button class="delete-vehicle-btn delete-btn" title="Elimina Mezzo" onclick="deleteVehicle('${vehicle.id}')">
                                 <span class="material-symbols-outlined">delete</span>
                             </button>
                         `;
                         vehiclesListContainer.appendChild(item);
                     });
                 }
            }

            // Populate select dropdown in home form
            if (vehicleSelect) {
                 // Save current value if exists (important for edits)
                 const currentValue = vehicleSelect.value;
                 vehicleSelect.innerHTML = '<option value="">-- Seleziona un mezzo --</option>'; // Reset options
                 console.log(`Popolamento select mezzi con ${vehicles.length} opzioni.`);
                 vehicles.forEach(vehicle => {
                     if (!vehicle || !vehicle.id || !vehicle.name) return; // Skip invalid
                     const option = document.createElement('option');
                     option.value = vehicle.id; // Use ID as value
                     const plateText = vehicle.plate ? ` (${escapeHtml(vehicle.plate)})` : '';
                     option.textContent = escapeHtml(vehicle.name) + plateText;
                     vehicleSelect.appendChild(option);
                 });
                 // Restore selected value if it still exists in the new list
                  if (vehicles.some(v => v && v.id === currentValue)) {
                     vehicleSelect.value = currentValue;
                     console.log(`Valore select mezzo ripristinato a: ${currentValue}`);
                  } else if (currentValue) {
                      console.log(`Valore select mezzo precedente (${currentValue}) non trovato nella nuova lista.`);
                  }
            }
        }

        function addVehicle() {
             console.log("Tentativo aggiunta mezzo...");
            const nameInput = document.getElementById('vehicleName');
            const plateInput = document.getElementById('vehiclePlate');

            if (!nameInput || !plateInput) {
                 console.error("Input nome o targa mezzo non trovati.");
                 showToast("Errore interno: Campi input mezzo mancanti.", "error");
                 return;
            }

            const name = nameInput.value.trim();
            const plate = plateInput.value.trim();

            if (!name) {
                showToast('Il nome del mezzo è obbligatorio.', "error");
                 nameInput.focus();
                return;
            }

            const db = getDb();
            if (!db.vehicles) { // Should be initialized by getDb, but double-check
                db.vehicles = [];
            }

            if (db.vehicles.length >= MAX_VEHICLES) {
                showToast(`Puoi aggiungere al massimo ${MAX_VEHICLES} mezzi.`, 'warning');
                return;
            }

             // Check for duplicate name (case-insensitive)
             if (db.vehicles.some(v => v.name.toLowerCase() === name.toLowerCase())) {
                 showToast('Un mezzo con questo nome esiste già.', 'warning');
                 nameInput.focus();
                 return;
             }


            const newVehicle = {
                id: 'vehicle_' + Date.now(), // Simple unique ID
                name: name,
                plate: plate
            };

            db.vehicles.push(newVehicle);
            saveDb(db);
            showToast(`Mezzo "${name}" aggiunto!`, 'success');
            console.log("Mezzo aggiunto:", newVehicle);
            loadVehicles(); // Reload lists and dropdown

            // Clear inputs
            nameInput.value = '';
            plateInput.value = '';
             nameInput.focus(); // Focus back on name for next entry
        }

        function deleteVehicle(vehicleId) {
             console.log(`Richiesta eliminazione mezzo ID: ${vehicleId}`);
             if (!vehicleId) {
                 console.error("ID mezzo non fornito per l'eliminazione.");
                 return;
             }
            const db = getDb();
             const vehicleToDelete = db.vehicles.find(v => v.id === vehicleId);

             if (!vehicleToDelete) {
                 console.warn(`Mezzo ${vehicleId} non trovato per l'eliminazione.`);
                 showToast("Mezzo non trovato.", "warning");
                 loadVehicles(); // Refresh list in case it was already deleted
                 return;
             }


            if (confirm(`Sei sicuro di voler eliminare il mezzo "${vehicleToDelete.name}"?`)) {
                db.vehicles = db.vehicles.filter(v => v.id !== vehicleId);
                saveDb(db);
                showToast(`Mezzo "${vehicleToDelete.name}" eliminato.`, 'success');
                console.log(`Mezzo ${vehicleId} eliminato.`);
                loadVehicles(); // Reload lists and dropdown
            } else {
                 console.log("Eliminazione mezzo annullata.");
            }
        }

         function getVehicleNameById(vehicleId) {
             if (!vehicleId) return '';
             const db = getDb();
             // Ensure vehicles exists and is an array
             const vehicles = Array.isArray(db.vehicles) ? db.vehicles : [];
             const vehicle = vehicles.find(v => v && v.id === vehicleId); // Check v exists
             return vehicle ? vehicle.name : ''; // Return name or empty string if not found or invalid
         }

        // --- Monthly Report Functions ---

         function initMonthlyReport() {
             const monthSelect = document.getElementById('exportMonthSelect');
             const exportExcelBtn = document.getElementById('exportMonthlyExcel');
              const reportContent = document.getElementById('monthlyReportContent');
              const reportSection = document.getElementById('monthly-report-section');

              // Check if elements exist
              if (!monthSelect || !exportExcelBtn || !reportContent || !reportSection) {
                   console.warn("Elementi del report mensile non trovati. Skip inizializzazione.");
                  return;
              }

              // Only fully initialize and display if the section is active
              if (!reportSection.classList.contains('active')) {
                  console.log("Sezione report mensile non attiva. Skip popolamento.");
                 return;
              }

             console.log("Inizializzazione Report Mensile...");

             populateMonthSelector(monthSelect);

             // Remove previous listeners before adding new ones to prevent duplicates
             monthSelect.replaceWith(monthSelect.cloneNode(true)); // Clone to remove listeners
             exportExcelBtn.replaceWith(exportExcelBtn.cloneNode(true));
             // Re-acquire elements after cloning
             const newMonthSelect = document.getElementById('exportMonthSelect');
             const newExportExcelBtn = document.getElementById('exportMonthlyExcel');
             const newReportContent = document.getElementById('monthlyReportContent'); // Content div doesn't need cloning


             newMonthSelect.addEventListener('change', () => {
                 console.log(`Selezione mese cambiata a: ${newMonthSelect.value}`);
                 displayMonthlyReport(newMonthSelect.value, newReportContent);
             });

             newExportExcelBtn.addEventListener('click', () => {
                 console.log(`Richiesta esportazione Excel per: ${newMonthSelect.value}`);
                 exportMonthlyReportToExcel(newMonthSelect.value);
             });

             // Display report for the initially selected (current) month
             if (newMonthSelect.value) {
                 displayMonthlyReport(newMonthSelect.value, newReportContent);
             } else {
                  console.log("Nessun mese selezionato inizialmente nel report.");
                 newReportContent.innerHTML = '<p class="monthly-report-empty">Seleziona un mese per visualizzare il riepilogo.</p>';
             }
         }

         function populateMonthSelector(selectElement) {
              console.log("Popolamento selettore mese...");
             const db = getDb();
             const months = new Set();
             const currentYearMonth = new Date().toISOString().slice(0, 7); // YYYY-MM

             // Add current month even if no data yet
             months.add(currentYearMonth);

             // Collect months from entries
             if (db.entries) {
                Object.keys(db.entries).forEach(dateStr => {
                    try {
                        const date = parseDate(dateStr);
                         if (!isNaN(date.getTime())) { // Check if date is valid
                             const yearMonth = date.toISOString().slice(0, 7);
                             months.add(yearMonth);
                         } else {
                              console.warn(`Data entry non valida trovata: ${dateStr}, skip per selettore mese.`);
                         }
                    } catch (e) { console.warn(`Errore parsing data entry ${dateStr}: ${e}`); }
                });
             }
             // Collect months from holidays/absences
             if (db.holidays) {
                Object.keys(db.holidays).forEach(dateStr => {
                     try {
                        const date = parseDate(dateStr);
                        if (!isNaN(date.getTime())) {
                             const yearMonth = date.toISOString().slice(0, 7);
                             months.add(yearMonth);
                        } else {
                             console.warn(`Data assenza non valida trovata: ${dateStr}, skip per selettore mese.`);
                        }
                    } catch (e) { console.warn(`Errore parsing data assenza ${dateStr}: ${e}`); }
                });
             }


             const sortedMonths = Array.from(months).sort().reverse(); // Most recent first

             selectElement.innerHTML = ''; // Clear existing options
              if (sortedMonths.length === 0) {
                  console.warn("Nessun mese trovato per popolare il selettore.");
                  // Add a placeholder option?
                   const option = document.createElement('option');
                   option.value = "";
                   option.textContent = "-- Nessun Mese --";
                   selectElement.appendChild(option);
                   selectElement.disabled = true;
                  return;
              }

             selectElement.disabled = false;
             sortedMonths.forEach(ym => {
                 const [year, month] = ym.split('-');
                 try {
                    const date = new Date(parseInt(year), parseInt(month) - 1, 1);
                     if (isNaN(date.getTime())) throw new Error("Data non valida creata");
                    const option = document.createElement('option');
                    option.value = ym; // YYYY-MM format
                    option.textContent = date.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                    // Select the current month by default
                    if (ym === currentYearMonth) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                 } catch(e) {
                      console.error(`Errore nella creazione dell'opzione mese per ${ym}: ${e}`);
                 }
             });
             console.log(`Selettore mese popolato con ${sortedMonths.length} opzioni.`);
         }

         function displayMonthlyReport(yearMonth, contentElement) {
              console.log(`Visualizzazione report per: ${yearMonth}`);
              contentElement.innerHTML = ''; // Clear previous content
              if (!yearMonth) {
                  contentElement.innerHTML = '<p class="monthly-report-empty">Seleziona un mese.</p>';
                  return;
              }

              const db = getDb();
              const [year, monthNum] = yearMonth.split('-').map(Number); // Month is 1-based here
              const monthIndex = monthNum - 1; // 0-based for Date object

              // --- Get all data points for the month (entries and holidays) ---
              const monthData = [];
              const daysInMonth = new Date(year, monthNum, 0).getDate();

              for (let day = 1; day <= daysInMonth; day++) {
                  try {
                     const date = new Date(year, monthIndex, day);
                      if (isNaN(date.getTime())) continue; // Skip invalid dates if any occur
                     const dateStr = formatDateForInput(date);
                     const entries = db.entries[dateStr] || [];
                     const holidayInfo = db.holidays[dateStr];

                     // Include day only if it has entries OR is an absence/holiday
                     if (entries.length > 0 || holidayInfo) {
                         monthData.push({
                             date: date,
                             dateStr: dateStr,
                             entries: entries,
                             holidayInfo: holidayInfo
                         });
                     }
                  } catch (e) {
                      console.error(`Errore processando giorno ${day} del mese ${yearMonth}: ${e}`);
                  }
              }

              // Sort data by date ascending
              monthData.sort((a, b) => a.date.getTime() - b.date.getTime());

              if (monthData.length === 0) {
                  contentElement.innerHTML = '<p class="monthly-report-empty">Nessun dato lavorativo o assenza registrata per questo mese.</p>';
                  console.log(`Nessun dato trovato per il report di ${yearMonth}`);
                  return;
              }
              console.log(`Trovati ${monthData.length} giorni con dati per il report di ${yearMonth}`);

             // --- Create Overall Monthly Stats ---
             let monthTotalHours = 0, monthTotalTransferta = 0, monthTotalNotturne = 0, monthWorkDays = 0, monthFerieDays = 0, monthMalattiaDays = 0;
              monthData.forEach(dayData => {
                 if (dayData.holidayInfo) {
                     if (dayData.holidayInfo.type === 'ferie') monthFerieDays++;
                     if (dayData.holidayInfo.type === 'malattia') monthMalattiaDays++;
                 } else if (dayData.entries.length > 0) {
                      let dayHasHours = false;
                     dayData.entries.forEach(e => {
                         monthTotalHours += (typeof e.totalHours === 'number' ? e.totalHours : 0);
                         monthTotalTransferta += (typeof e.transferta === 'number' ? e.transferta : 0);
                         monthTotalNotturne += (typeof e.notturne === 'number' ? e.notturne : 0);
                          if (typeof e.totalHours === 'number' && e.totalHours > 0) dayHasHours = true;
                     });
                      if(dayHasHours) monthWorkDays++;
                 }
              });

              const statsHtml = `
                 <div class="monthly-report-stats card" style="background-color: var(--md-sys-color-surface-variant); padding: 1rem; margin-bottom: 1.5rem;">
                     <div class="monthly-stat-item" style="background-color: var(--md-sys-color-surface);">
                         <span class="monthly-stat-value">${monthTotalHours.toFixed(1)}h</span>
                         <span class="monthly-stat-label">Ore Lavorate</span>
                     </div>
                      <div class="monthly-stat-item" style="background-color: var(--md-sys-color-surface);">
                         <span class="monthly-stat-value">${monthWorkDays}</span>
                         <span class="monthly-stat-label">Giorni Lavorati</span>
                     </div>
                     <div class="monthly-stat-item" style="background-color: var(--md-sys-color-surface);">
                         <span class="monthly-stat-value">${monthTotalTransferta.toFixed(1)}h</span>
                         <span class="monthly-stat-label">Ore Trasferta</span>
                     </div>
                     <div class="monthly-stat-item" style="background-color: var(--md-sys-color-surface);">
                         <span class="monthly-stat-value">${monthTotalNotturne.toFixed(1)}h</span>
                         <span class="monthly-stat-label">Ore Notturne</span>
                     </div>
                      ${monthFerieDays > 0 ? `
                      <div class="monthly-stat-item" style="background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);">
                         <span class="monthly-stat-value" style="color: var(--md-sys-color-tertiary);">${monthFerieDays}</span>
                         <span class="monthly-stat-label">Giorni Ferie</span>
                     </div>` : ''}
                     ${monthMalattiaDays > 0 ? `
                      <div class="monthly-stat-item" style="background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container);">
                         <span class="monthly-stat-value" style="color: var(--md-sys-color-secondary);">${monthMalattiaDays}</span>
                         <span class="monthly-stat-label">Giorni Malattia</span>
                     </div>` : ''}
                 </div>
              `;
              contentElement.innerHTML = statsHtml; // Use '=' to replace previous content, starting with stats

              // --- Create Detailed Daily List ---
              const listContainer = document.createElement('div'); // Container for list items
              monthData.forEach(dayData => {
                 const itemDiv = document.createElement('div');
                 itemDiv.className = 'monthly-report-item';

                 const dateDisplay = dayData.date.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short' });
                 let contentHtml = `<div class="monthly-report-date">${dateDisplay}</div>`;

                 if (dayData.holidayInfo) {
                      // --- Absence Entry ---
                      const typeText = dayData.holidayInfo.type === 'ferie' ? 'Ferie' : 'Malattia';
                      const icon = dayData.holidayInfo.type === 'ferie' ? 'beach_access' : 'sick';
                       itemDiv.classList.add(dayData.holidayInfo.type === 'ferie' ? 'ferie-entry' : 'malattia-entry'); // Add class for styling
                      contentHtml += `
                         <div class="monthly-report-details">
                              <span class="monthly-report-detail" style="background-color: inherit; color: inherit; font-weight: 500;">
                                 <span class="material-symbols-outlined" style="font-size: 1.1em; vertical-align: text-bottom;">${icon}</span>
                                 ${typeText}
                              </span>
                         </div>`;
                       if (dayData.holidayInfo.note) {
                           contentHtml += `<p class="monthly-report-description">${escapeHtml(dayData.holidayInfo.note)}</p>`;
                       }

                 } else if (dayData.entries.length > 0) {
                     // --- Work Entries ---
                     let dayTotalHours = 0, dayTotalTransferta = 0, dayTotalNotturne = 0;
                     let entryDetailsHtml = ''; // Accumulate details for individual entries
                     dayData.entries.forEach(entry => {
                         dayTotalHours += (typeof entry.totalHours === 'number' ? entry.totalHours : 0);
                         dayTotalTransferta += (typeof entry.transferta === 'number' ? entry.transferta : 0);
                         dayTotalNotturne += (typeof entry.notturne === 'number' ? entry.notturne : 0);

                          // Add individual entry details
                          const vehicleName = getVehicleNameById(entry.vehicle);
                          const entryTime = `${entry.startTime || '?'} - ${entry.endTime || '?'}`;
                          const entryHours = typeof entry.totalHours === 'number' ? ` (${entry.totalHours.toFixed(1)}h)` : '';
                          const entryDesc = entry.description ? `<p class="monthly-report-description" style="margin-top: 0;">${escapeHtml(entry.description)}</p>` : '';
                          const entryVehicle = vehicleName ? `<p class="monthly-report-vehicle" style="margin-top: 0;"><span class="material-symbols-outlined" style="font-size: 1em;">directions_car</span> ${escapeHtml(vehicleName)}</p>` : '';

                         entryDetailsHtml += `<div style="margin-left: 1rem; margin-top: 0.5rem; padding-left: 0.5rem; border-left: 2px solid var(--md-sys-color-outline-variant); font-size: 0.9em;">
                                                <span style="color: var(--md-sys-color-on-surface-variant);">${entryTime}${entryHours}</span>
                                                ${entryDesc}
                                                ${entryVehicle}
                                            </div>`;
                     });

                      // Summary details for the day
                      contentHtml += `<div class="monthly-report-details">
                                      <span class="monthly-report-detail"><strong>${dayTotalHours.toFixed(1)}h</strong> Totali</span>`;
                      if (dayTotalTransferta > 0) contentHtml += `<span class="monthly-report-detail"><span class="material-symbols-outlined">local_shipping</span> ${dayTotalTransferta.toFixed(1)}h Trasf.</span>`;
                      if (dayTotalNotturne > 0) contentHtml += `<span class="monthly-report-detail"><span class="material-symbols-outlined">dark_mode</span> ${dayTotalNotturne.toFixed(1)}h Nott.</span>`;
                      contentHtml += `</div>`;
                      // Append individual entry details
                      contentHtml += entryDetailsHtml;
                 }

                 itemDiv.innerHTML = contentHtml;
                 listContainer.appendChild(itemDiv); // Add to container
             });
             contentElement.appendChild(listContainer); // Append the whole list at once
             console.log("Report mensile visualizzato.");
         }

        function exportMonthlyReportToExcel(yearMonth) {
             console.log(`Inizio esportazione Excel per ${yearMonth}...`);
             if (!yearMonth) {
                showToast("Seleziona un mese da esportare.", "warning");
                return;
            }
             if (typeof XLSX === 'undefined') {
                 showToast("Libreria per export Excel non caricata.", "error");
                 console.error("Libreria SheetJS (XLSX) non trovata.");
                 return;
             }


            const db = getDb();
             const userName = localStorage.getItem('userName') || 'Utente';
            const [year, monthNum] = yearMonth.split('-').map(Number);
            const monthIndex = monthNum - 1;
            const monthName = new Date(year, monthIndex, 1).toLocaleDateString('it-IT', { month: 'long' });
            const filename = `ReportOre_${userName}_${monthName}_${year}.xlsx`;

             // --- Prepare data array for SheetJS ---
             const excelData = [];
             // Header Row
             excelData.push([
                 "Data", "Giorno", "Tipo", "Ora Inizio", "Ora Fine", "Pausa (h)",
                 "Ore Lavorate", "Ore Trasferta", "Ore Notturne", "Descrizione/Note", "Mezzo"
             ]);

             const daysInMonth = new Date(year, monthNum, 0).getDate();
              let monthTotalHours = 0, monthTotalTransferta = 0, monthTotalNotturne = 0, monthWorkDays = 0, monthFerieDays = 0, monthMalattiaDays = 0;
              const numberFormat = '#,##0.0'; // Basic number format for hours
              const integerFormat = '0'; // Basic integer format for days

             for (let day = 1; day <= daysInMonth; day++) {
                 const date = new Date(year, monthIndex, day);
                  if (isNaN(date.getTime())) continue; // Skip invalid dates
                 const dateStr = formatDateForInput(date);
                 const dayOfWeek = date.toLocaleDateString('it-IT', { weekday: 'short' });
                 const entries = db.entries[dateStr] || [];
                 const holidayInfo = db.holidays[dateStr];

                  if (holidayInfo) {
                      // --- Absence Row ---
                      const typeText = holidayInfo.type === 'ferie' ? 'Ferie' : 'Malattia';
                      excelData.push([
                          dateStr, dayOfWeek, typeText, "", "", "", // Empty time/hours
                           "", "", "", // Empty work hours
                          holidayInfo.note || "", "" // Note and empty vehicle
                      ]);
                       if (holidayInfo.type === 'ferie') monthFerieDays++;
                       if (holidayInfo.type === 'malattia') monthMalattiaDays++;

                  } else if (entries.length > 0) {
                       // --- Work Entry Rows ---
                       let dayHasWork = false;
                      entries.forEach(entry => {
                          const vehicleName = getVehicleNameById(entry.vehicle);
                          // Ensure numeric types for Excel
                           const breakTimeNum = typeof entry.breakTime === 'number' ? entry.breakTime : 0;
                           const totalHoursNum = typeof entry.totalHours === 'number' ? entry.totalHours : 0;
                           const transfertaNum = typeof entry.transferta === 'number' ? entry.transferta : 0;
                           const notturneNum = typeof entry.notturne === 'number' ? entry.notturne : 0;

                           excelData.push([
                              dateStr, dayOfWeek, "Lavoro",
                              entry.startTime || "", entry.endTime || "",
                              { v: breakTimeNum, t: 'n', z: numberFormat }, // Pause
                              { v: totalHoursNum, t: 'n', z: numberFormat }, // Total Hours
                              { v: transfertaNum, t: 'n', z: numberFormat }, // Transferta
                              { v: notturneNum, t: 'n', z: numberFormat }, // Notturne
                              entry.description || "", vehicleName
                           ]);
                            monthTotalHours += totalHoursNum;
                            monthTotalTransferta += transfertaNum;
                            monthTotalNotturne += notturneNum;
                            if (totalHoursNum > 0) dayHasWork = true;
                      });
                       if (dayHasWork) monthWorkDays++;
                  } else {
                      // --- Empty Day Row (Optional) ---
                      // Could add weekends or empty workdays if desired
                      // excelData.push([dateStr, dayOfWeek, "-", "", "", "", "", "", "", "", ""]);
                  }
             }

             // --- Add Summary Rows ---
             excelData.push([]); // Empty separator row
             excelData.push(["Riepilogo Mensile:", `${monthName} ${year}`]);
             excelData.push(["", ""]); // Spacer
             excelData.push(["Descrizione", "Valore"]);
             excelData.push(["Ore Lavorate Totali:", {v: monthTotalHours, t:'n', z: numberFormat}]);
             excelData.push(["Giorni Lavorati:", {v: monthWorkDays, t:'n', z: integerFormat}]);
             excelData.push(["Ore Trasferta Totali:", {v: monthTotalTransferta, t:'n', z: numberFormat}]);
             excelData.push(["Ore Notturne Totali:", {v: monthTotalNotturne, t:'n', z: numberFormat}]);
              if (monthFerieDays > 0) excelData.push(["Giorni Ferie:", {v: monthFerieDays, t:'n', z: integerFormat}]);
              if (monthMalattiaDays > 0) excelData.push(["Giorni Malattia:", {v: monthMalattiaDays, t:'n', z: integerFormat}]);

             // --- Create worksheet and workbook ---
              try {
                 const ws = XLSX.utils.aoa_to_sheet(excelData);

                 // --- Define Column Widths ---
                 ws['!cols'] = [
                     { wch: 12 }, // Data
                     { wch: 8 },  // Giorno
                     { wch: 10 }, // Tipo
                     { wch: 10 }, // Ora Inizio
                     { wch: 10 }, // Ora Fine
                     { wch: 10 }, // Pausa (h)
                     { wch: 12 }, // Ore Lavorate
                     { wch: 12 }, // Ore Trasferta
                     { wch: 12 }, // Ore Notturne
                     { wch: 35 }, // Descrizione/Note
                     { wch: 20 }  // Mezzo
                 ];

                 // --- Apply Basic Formatting (Example: Bold Header) ---
                 // Find the range of the sheet
                 const range = XLSX.utils.decode_range(ws['!ref']);
                 for (let C = range.s.c; C <= range.e.c; ++C) {
                     const cell_address = { c: C, r: 0 }; // Header row (0)
                     const cell_ref = XLSX.utils.encode_cell(cell_address);
                     if (ws[cell_ref]) {
                         if (!ws[cell_ref].s) ws[cell_ref].s = {}; // Ensure style object exists
                         ws[cell_ref].s.font = { bold: true };
                     }
                 }
                 // Bold summary labels
                 const summaryStartRow = daysInMonth + 3; // Adjust based on actual data rows + separators
                  for (let R = summaryStartRow; R < excelData.length; ++R) {
                       const cell_address = { c: 0, r: R }; // First column (0)
                       const cell_ref = XLSX.utils.encode_cell(cell_address);
                       if (ws[cell_ref] && ws[cell_ref].v) { // Check if cell and value exist
                           if (!ws[cell_ref].s) ws[cell_ref].s = {};
                           ws[cell_ref].s.font = { bold: true };
                       }
                  }


                 const wb = XLSX.utils.book_new();
                 XLSX.utils.book_append_sheet(wb, ws, 'Report Ore');

                 // --- Trigger download ---
                 XLSX.writeFile(wb, filename);
                 showToast('Report Excel esportato!', 'success');
                 console.log(`Esportazione Excel completata: ${filename}`);
              } catch (excelError) {
                   console.error("Errore durante la creazione del file Excel:", excelError);
                   showToast(`Errore durante la creazione dell'Excel: ${excelError.message}`, "error");
              }
        }


        // --- Ferie/Malattie Functions ---

        function initFerieMalattieSection() {
            // Get elements needed for initialization
            const multipleDaysCheckbox = document.getElementById('multipleDays');
            const singleDateGroup = document.getElementById('singleDateGroup');
            const dateRangeGroup = document.getElementById('dateRangeGroup');
            const saveBtn = document.getElementById('saveFerieMalattie');
            const section = document.getElementById('ferie-malattie-section');

            if (!multipleDaysCheckbox || !singleDateGroup || !dateRangeGroup || !saveBtn || !section) {
                console.warn("Elementi Ferie/Malattie mancanti. Skip inizializzazione listener.");
                return;
            }

             // Only init fully if section is active
            if (!section.classList.contains('active')) {
                 console.log("Sezione Ferie/Malattie non attiva. Skip inizializzazione completa.");
                 return;
            }
             console.log("Inizializzazione Sezione Ferie/Malattie...");

             // Initialize datepickers specifically for this section
             initFerieMalattieDatepickers();

             // Use replaceWith clone to ensure listeners are fresh if section is revisited
             const freshCheckbox = multipleDaysCheckbox.cloneNode(true);
             multipleDaysCheckbox.parentNode.replaceChild(freshCheckbox, multipleDaysCheckbox);
             freshCheckbox.addEventListener('change', () => {
                singleDateGroup.style.display = freshCheckbox.checked ? 'none' : 'block';
                dateRangeGroup.style.display = freshCheckbox.checked ? 'block' : 'none';
                // Reset dates when toggling
                 if (typeof flatpickr !== 'undefined') {
                    document.querySelectorAll('.datepicker-ferie').forEach(input => {
                        if(input._flatpickr) input._flatpickr.clear();
                    });
                 } else {
                      document.querySelectorAll('.datepicker-ferie').forEach(input => input.value = '');
                 }
            });

            // Initial state based on checkbox (might be pre-checked if navigating back)
             singleDateGroup.style.display = freshCheckbox.checked ? 'none' : 'block';
             dateRangeGroup.style.display = freshCheckbox.checked ? 'block' : 'none';


             const freshSaveBtn = saveBtn.cloneNode(true);
             saveBtn.parentNode.replaceChild(freshSaveBtn, saveBtn);
             freshSaveBtn.addEventListener('click', saveFerieMalattieEntry);


             // Initial load of entries list
             loadFerieMalattieEntries();
        }

        function initFerieMalattieDatepickers() {
             // Ensure flatpickr is loaded
             if (typeof flatpickr !== 'function') {
                 console.error("Flatpickr non caricato. Impossibile inizializzare datepicker Ferie/Malattie.");
                 return;
             }

             const commonOptions = {
                 dateFormat: "d/m/Y",
                 locale: "it",
                 allowInput: true, // Allow manual input
                 appendTo: document.body,
                 disableMobile: true, // Use styled picker
                 errorHandler: (error) => { // Handle flatpickr errors
                     console.error("Errore Flatpickr (Ferie/Malattie):", error);
                     showToast(`Errore calendario: ${error.message}`, "error");
                 }
             };

             // Function to initialize or re-initialize a picker
             const setupPicker = (selector) => {
                 const el = document.querySelector(selector);
                 if (!el) {
                      console.warn(`Elemento datepicker non trovato: ${selector}`);
                      return;
                 }
                 // Destroy previous instance if it exists
                 if (el._flatpickr) {
                     try { el._flatpickr.destroy(); } catch(e) { console.warn(`Errore distruggendo istanza ${selector}: ${e}`); }
                 }
                 // Initialize new instance
                 flatpickr(el, commonOptions);
             };


             // Initialize pickers
             setupPicker('#ferieMalattieDate');
             setupPicker('#ferieMalattieStartDate');
             setupPicker('#ferieMalattieEndDate');

              console.log("Datepicker Ferie/Malattie inizializzati.");
         }

        function saveFerieMalattieEntry() {
             console.log("Tentativo salvataggio Ferie/Malattia...");
            const db = getDb();
            const typeSelect = document.getElementById('ferieMalattieType');
            const multipleDaysCheckbox = document.getElementById('multipleDays');
            const singleDateInput = document.getElementById('ferieMalattieDate');
            const startDateInput = document.getElementById('ferieMalattieStartDate');
            const endDateInput = document.getElementById('ferieMalattieEndDate');
            const noteInput = document.getElementById('ferieMalattieNote');

             // Validate elements exist
             if (!typeSelect || !multipleDaysCheckbox || !singleDateInput || !startDateInput || !endDateInput || !noteInput) {
                 console.error("Elementi form Ferie/Malattie mancanti.");
                  showToast("Errore interno: Elementi form mancanti.", "error");
                 return;
             }

            const type = typeSelect.value;
            const isMultiple = multipleDaysCheckbox.checked;
            const note = noteInput.value.trim();

            let datesToAdd = [];
            let errorOccurred = false;

            if (isMultiple) {
                // --- Multiple Days ---
                const startDateStr = startDateInput.value;
                const endDateStr = endDateInput.value;
                if (!startDateStr || !endDateStr) {
                    showToast("Seleziona le date di inizio e fine.", "error");
                    return;
                }
                const startDate = parseDate(startDateStr);
                const endDate = parseDate(endDateStr);
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    showToast("Date di inizio o fine non valide.", "error");
                    return;
                }
                if (endDate < startDate) {
                    showToast("La data di fine non può essere precedente alla data di inizio.", "error");
                    return;
                }

                 // Limit range to prevent accidental large additions? (e.g., 90 days)
                 const maxRangeDays = 90;
                 const diffTime = Math.abs(endDate - startDate);
                 const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include start date
                 if (diffDays > maxRangeDays) {
                     showToast(`L'intervallo selezionato (${diffDays} giorni) è troppo lungo (max ${maxRangeDays}).`, "error");
                     return;
                 }


                // Generate all dates in the range
                 console.log(`Salvataggio ${type} da ${startDateStr} a ${endDateStr}`);
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                     if (isNaN(currentDate.getTime())) { // Safety check inside loop
                          console.error("Data non valida generata nel ciclo range:", currentDate);
                          errorOccurred = true;
                          break;
                     }
                    datesToAdd.push(formatDateForInput(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }

            } else {
                // --- Single Day ---
                const singleDateStr = singleDateInput.value;
                if (!singleDateStr) {
                    showToast("Seleziona una data.", "error");
                    return;
                }
                const singleDate = parseDate(singleDateStr);
                 if (isNaN(singleDate.getTime())) {
                    showToast("Data selezionata non valida.", "error");
                    return;
                }
                 console.log(`Salvataggio ${type} per ${singleDateStr}`);
                datesToAdd.push(singleDateStr);
            }

             if (errorOccurred) {
                 showToast("Errore nella generazione delle date. Salvataggio annullato.", "error");
                 return;
             }
            if (datesToAdd.length === 0) {
                 showToast("Nessuna data valida da salvare.", "warning");
                 return;
            }

            if (!db.holidays) db.holidays = {};

            let conflicts = [];
            let addedCount = 0;
            datesToAdd.forEach(dateStr => {
                 // Check if there's already a work entry - confirm overwrite
                 if (db.entries[dateStr] && db.entries[dateStr].length > 0) {
                     conflicts.push(dateStr);
                 } else if (db.holidays[dateStr] && db.holidays[dateStr].type !== type) {
                     // Allow overwriting same type, but warn if changing type (e.g., ferie -> malattia)
                     conflicts.push(dateStr);
                 } else {
                     // Add or overwrite absence
                      db.holidays[dateStr] = { type: type, note: note };
                      addedCount++;
                 }
            });

            // Handle conflicts
             if (conflicts.length > 0) {
                 const conflictMsg = `Attenzione: I seguenti giorni hanno già voci di lavoro o un diverso tipo di assenza: ${conflicts.join(', ')}. Vuoi sovrascrivere e impostarli come ${type}? Le ore lavorate verranno ignorate nei totali.`;
                 if (confirm(conflictMsg)) {
                      console.log("Conflitti confermati dall'utente, sovrascrittura...");
                     conflicts.forEach(dateStr => {
                         db.holidays[dateStr] = { type: type, note: note };
                         // Optionally delete work entries for this day?
                         // if (db.entries[dateStr]) delete db.entries[dateStr];
                         addedCount++;
                     });
                 } else {
                      showToast("Salvataggio parziale o annullato a causa di conflitti.", "info");
                 }
             }


            if (addedCount > 0) {
                saveDb(db);
                const typeText = type === 'ferie' ? (addedCount > 1 ? 'Ferie salvate' : 'Ferie salvata') : (addedCount > 1 ? 'Malattie salvate' : 'Malattia salvata');
                showToast(`${typeText} per ${addedCount} giorn${addedCount > 1 ? 'i' : 'o'}.`, 'success');
                console.log(`Salvat* ${addedCount} giorni come ${type}.`);

                // Reload relevant views
                if (typeof loadFerieMalattieEntries === 'function') loadFerieMalattieEntries();
                 if (document.getElementById('calendar-section')?.classList.contains('active') && typeof loadCalendarData === 'function') loadCalendarData();
                 if (document.getElementById('monthly-report-section')?.classList.contains('active') && typeof displayMonthlyReport === 'function') {
                      const monthSelect = document.getElementById('exportMonthSelect');
                      if (monthSelect) displayMonthlyReport(monthSelect.value, document.getElementById('monthlyReportContent'));
                 }

                 // Reset form fields only if something was actually saved
                 multipleDaysCheckbox.checked = false;
                 if (singleDateInput._flatpickr) singleDateInput._flatpickr.clear(); else singleDateInput.value = '';
                 if (startDateInput._flatpickr) startDateInput._flatpickr.clear(); else startDateInput.value = '';
                 if (endDateInput._flatpickr) endDateInput._flatpickr.clear(); else endDateInput.value = '';
                 noteInput.value = '';
                 // Trigger checkbox change to reset visibility
                 const event = new Event('change');
                 multipleDaysCheckbox.dispatchEvent(event);

            } else if (conflicts.length > 0 && addedCount === 0) {
                 console.log("Nessuna voce aggiunta a causa di conflitti non risolti.");
            } else {
                 console.log("Nessuna voce da aggiungere o sovrascrivere.");
                 // No toast needed if nothing changed
            }


        }

         function loadFerieMalattieEntries() {
             const entriesContainer = document.getElementById('ferieMalattieEntries');
              if (!entriesContainer) {
                   console.warn("Contenitore lista Ferie/Malattie non trovato.");
                   return;
              }
             console.log("Caricamento lista Ferie/Malattie...");
             const db = getDb();
             entriesContainer.innerHTML = ''; // Clear list

             const allHolidayEntries = Object.entries(db.holidays || {})
                 .map(([dateStr, info]) => {
                      // Basic validation of the entry structure
                      if (typeof info !== 'object' || !info.type) {
                           console.warn(`Voce assenza non valida per ${dateStr}:`, info);
                           return null; // Skip invalid entries
                      }
                      return { dateStr, ...info };
                 })
                 .filter(entry => entry !== null) // Remove null entries
                 .sort((a, b) => parseDate(b.dateStr).getTime() - parseDate(a.dateStr).getTime()); // Sort descending by date

             if (allHolidayEntries.length === 0) {
                 entriesContainer.innerHTML = '<p style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: 1rem;">Nessuna voce di ferie o malattia inserita.</p>';
                 console.log("Nessuna voce Ferie/Malattia trovata.");
                 return;
             }

             console.log(`Visualizzazione ${allHolidayEntries.length} voci Ferie/Malattie.`);
             allHolidayEntries.forEach(entry => {
                 const div = document.createElement('div');
                 div.className = 'ferie-malattie-entry';
                 const date = parseDate(entry.dateStr);
                  if (isNaN(date.getTime())) {
                       console.warn(`Data non valida ${entry.dateStr} nella lista assenze, skip.`);
                       return; // Skip if date is invalid
                  }
                 const typeText = entry.type === 'ferie' ? 'Ferie' : 'Malattia';
                  const icon = entry.type === 'ferie' ? 'beach_access' : 'sick';

                 div.innerHTML = `
                     <div class="ferie-malattie-info">
                         <div class="ferie-malattie-header">
                             <span class="ferie-malattie-type">
                                 <span class="material-symbols-outlined">${icon}</span>
                                 ${typeText}
                             </span>
                             <span class="ferie-malattie-date">${date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' })}</span>
                         </div>
                         ${entry.note ? `<p class="ferie-malattie-note">${escapeHtml(entry.note)}</p>` : ''}
                     </div>
                     <div class="ferie-malattie-actions">
                         <button class="delete-ferie-btn delete-btn" title="Elimina Assenza" onclick="deleteFerieMalattieEntry('${entry.dateStr}')">
                              <span class="material-symbols-outlined">delete</span>
                         </button>
                     </div>
                 `;
                 entriesContainer.appendChild(div);
             });
         }

         function deleteFerieMalattieEntry(dateStr) {
               console.log(`Richiesta eliminazione assenza per ${dateStr}`);
               const db = getDb();
               const holidayInfo = db.holidays ? db.holidays[dateStr] : null;

                if (!holidayInfo) {
                    console.warn(`Assenza non trovata per ${dateStr} per l'eliminazione.`);
                    showToast("Voce di assenza non trovata.", "warning");
                    loadFerieMalattieEntries(); // Refresh list
                    return;
                }

               const typeText = holidayInfo.type === 'ferie' ? 'Ferie' : 'Malattia';
              if (confirm(`Sei sicuro di voler eliminare la voce di ${typeText} per il ${dateStr}?`)) {
                 if (db.holidays && db.holidays[dateStr]) { // Double check it exists before deleting
                     delete db.holidays[dateStr];
                     saveDb(db);
                     showToast(`${typeText} eliminata per ${dateStr}.`, 'success');
                     console.log(`Assenza eliminata per ${dateStr}.`);
                     // Reload relevant views
                     loadFerieMalattieEntries(); // Reload list
                      if (document.getElementById('calendar-section')?.classList.contains('active') && typeof loadCalendarData === 'function') loadCalendarData();
                      if (document.getElementById('monthly-report-section')?.classList.contains('active') && typeof displayMonthlyReport === 'function') {
                          const monthSelect = document.getElementById('exportMonthSelect');
                          if (monthSelect) displayMonthlyReport(monthSelect.value, document.getElementById('monthlyReportContent'));
                     }
                 } else {
                      // Should not happen due to check above, but handle defensively
                      console.warn(`Assenza per ${dateStr} scomparsa prima dell'eliminazione effettiva.`);
                       showToast("Voce di assenza non trovata (potrebbe essere già stata eliminata).", "warning");
                       loadFerieMalattieEntries();
                 }
             } else {
                  console.log("Eliminazione assenza annullata.");
             }
         }

         function loadFerieMalattieTypes() {
            // Currently types are hardcoded in select. This function is a placeholder.
            console.log("Tipi Ferie/Malattie caricati (staticamente).");
         }


        // --- Utility Functions ---

        /**
         * Parses a date string in dd/mm/yyyy format into a Date object.
         * Returns Invalid Date object if parsing fails.
         */
        function parseDate(dateStr) {
             if (!dateStr || typeof dateStr !== 'string') {
                 return new Date(NaN); // Return Invalid Date
             }
             const parts = dateStr.split('/');
             if (parts.length === 3) {
                 const day = parseInt(parts[0], 10);
                 const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed in Date
                 const year = parseInt(parts[2], 10);
                 // Basic validation of parts
                 if (!isNaN(day) && !isNaN(month) && !isNaN(year) && year > 1900 && year < 3000 && month >= 0 && month <= 11 && day > 0 && day <= 31) {
                      const date = new Date(Date.UTC(year, month, day)); // Use UTC to avoid timezone issues
                      // Final check to catch invalid dates like 31/04/2023 and ensure parts match
                      if (date.getUTCFullYear() === year && date.getUTCMonth() === month && date.getUTCDate() === day) {
                          return date;
                      }
                 }
             }
             return new Date(NaN); // Return Invalid Date if format is wrong or date invalid
        }

         /**
         * Formats a Date object into a dd/mm/yyyy string.
         * Returns empty string if date is invalid.
         */
        function formatDateForInput(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                // console.warn('formatDateForInput: data non valida', date);
                return '';
            }
            try {
                const day = date.getUTCDate().toString().padStart(2, '0');
                const month = (date.getUTCMonth() + 1).toString().padStart(2, '0'); // Use UTC month
                const year = date.getUTCFullYear();
                return `${day}/${month}/${year}`;
            } catch (error) {
                console.error('Errore nella formattazione della data per input:', error);
                return '';
            }
        }

        /**
         * Formats a date (string dd/mm/yyyy or Date object) for display.
         * Returns input string if already formatted, or formatted string, or empty string on error.
         */
        function formatDate(date) {
            if (!date) return '';
            if (typeof date === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(date)) {
                return date; // Already correct format
            }
             let dateObj = date;
             if (typeof date === 'string') {
                  dateObj = parseDate(date); // Attempt to parse if string but wrong format
             }

            if (dateObj instanceof Date && !isNaN(dateObj.getTime())) {
                return formatDateForInput(dateObj); // Reuse the input formatter
            } else {
                 console.warn('formatDate: impossibile formattare data', date);
                return '';
            }
        }


        /**
         * Checks if a date is an Italian holiday (fixed + Easter based).
         */
        function isItalianHoliday(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return false;
            }

            const day = date.getUTCDate();
            const month = date.getUTCMonth() + 1; // Month is 1-based for checks
            const year = date.getUTCFullYear();

            // Fixed holidays (day/month)
            const fixedHolidays = [
                "1/1", "6/1", "25/4", "1/5", "2/6", "15/8", "1/11", "8/12", "25/12", "26/12"
            ];
            if (fixedHolidays.includes(`${day}/${month}`)) {
                return true;
            }

            // Easter calculation (Gauss algorithm - simpler version)
            const a = year % 19;
            const b = year % 4;
            const c = year % 7;
            const k = Math.floor(year / 100);
            const p = Math.floor((13 + 8 * k) / 25);
            const q = Math.floor(k / 4);
            const M = (15 - p + k - q) % 30;
            const N = (4 + k - q) % 7;
            const d = (19 * a + M) % 30;
            const e = (2 * b + 4 * c + 6 * d + N) % 7;

            let easterDay, easterMonth;
            if (d === 29 && e === 6) {
                easterDay = 19; easterMonth = 4; // April 19
            } else if (d === 28 && e === 6 && (11 * M + 11) % 30 < 19) {
                easterDay = 18; easterMonth = 4; // April 18
            } else {
                 const dayOffset = d + e;
                 if (dayOffset < 10) {
                     easterDay = dayOffset + 22; easterMonth = 3; // March
                 } else {
                     easterDay = dayOffset - 9; easterMonth = 4; // April
                 }
            }

            // Check Easter Sunday
             if (day === easterDay && month === easterMonth) {
                 return true;
             }

            // Check Easter Monday (Pasquetta)
             const easterDate = new Date(Date.UTC(year, easterMonth - 1, easterDay));
             const easterMonday = new Date(easterDate);
             easterMonday.setUTCDate(easterDate.getUTCDate() + 1);
              if (day === easterMonday.getUTCDate() && month === easterMonday.getUTCMonth() + 1) {
                  return true;
              }


            return false;
        }

        /**
         * Gets the name of an Italian holiday for a specific date.
         */
        function getHolidayName(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return '';
            }

            const day = date.getUTCDate();
            const month = date.getUTCMonth() + 1; // 1-based
            const year = date.getUTCFullYear();

            // Fixed holidays names
            const holidayNames = {
                '1/1': 'Capodanno', '6/1': 'Epifania', '25/4': 'Liberazione',
                '1/5': 'Festa Lavoro', '2/6': 'Festa Repubblica', '15/8': 'Ferragosto',
                '1/11': 'Tutti i Santi', '8/12': 'Immacolata', '25/12': 'Natale', '26/12': 'S. Stefano'
            };
            if (holidayNames[`${day}/${month}`]) {
                return holidayNames[`${day}/${month}`];
            }

            // Calculate Easter date again (or reuse calculation if optimized)
             const a = year % 19, b = year % 4, c = year % 7, k = Math.floor(year / 100), p = Math.floor((13 + 8 * k) / 25), q = Math.floor(k / 4);
             const M = (15 - p + k - q) % 30, N = (4 + k - q) % 7;
             const d = (19 * a + M) % 30, e = (2 * b + 4 * c + 6 * d + N) % 7;
             let easterDay, easterMonth;
             if (d === 29 && e === 6) { easterDay = 19; easterMonth = 4; }
             else if (d === 28 && e === 6 && (11 * M + 11) % 30 < 19) { easterDay = 18; easterMonth = 4; }
             else { const dayOffset = d + e; if (dayOffset < 10) { easterDay = dayOffset + 22; easterMonth = 3; } else { easterDay = dayOffset - 9; easterMonth = 4; } }

            if (day === easterDay && month === easterMonth) return 'Pasqua';

             const easterDate = new Date(Date.UTC(year, easterMonth - 1, easterDay));
             const easterMonday = new Date(easterDate);
             easterMonday.setUTCDate(easterDate.getUTCDate() + 1);
              if (day === easterMonday.getUTCDate() && month === easterMonday.getUTCMonth() + 1) return 'Pasquetta';


            return '';
        }


        /**
         * Calculates total work hours based on start, end, and break times.
         * Handles overnight shifts.
         */
        function calculateTotalHours() {
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');
            const breakTimeInput = document.getElementById('breakTime');
            const totalHoursInput = document.getElementById('totalHours');

             if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalHoursInput) {
                 // console.warn("Elementi mancanti per calcolo ore totali.");
                 return; // Don't proceed if elements are missing
             }

            try {
                 // Use parseFloat for decimal hours, default to NaN if invalid
                 const startStr = startTimeInput.value.replace(',', '.'); // Allow comma decimal
                 const endStr = endTimeInput.value.replace(',', '.');
                 const breakStr = breakTimeInput.value.replace(',', '.');

                 const startTime = parseFloat(startStr);
                 const endTime = parseFloat(endStr);
                 const breakTime = parseFloat(breakStr) || 0; // Default break to 0 if invalid

                 // Only calculate if start and end times are valid numbers
                 if (!isNaN(startTime) && !isNaN(endTime)) {
                     let totalHours = 0;

                      // Normalize times (e.g., handle 24 as 0 for calculation, but maybe allow 24 as input?)
                      // Let's assume input is 0-23.99 range, or integer hours 0-24
                      let start = startTime;
                      let end = endTime;

                      // Simple check for overnight: if end time is numerically smaller than start time
                      if (end < start) {
                          // Overnight shift
                          totalHours = (24 - start) + end;
                      } else if (end === start) {
                           // Could be 24 hours or 0 hours. Assume 0 unless explicitly 24?
                           // If start is 0 and end is 0, it's 0 hours. If start is 7 end is 7, likely error or 0.
                           // Let's assume 0 if times are equal.
                           totalHours = 0;
                      }
                       else {
                          // Same day shift
                          totalHours = end - start;
                      }

                     // Subtract break time, ensure result is not negative
                     totalHours = Math.max(0, totalHours - breakTime);

                     // Update the totalHours field, formatted to one decimal place
                     totalHoursInput.value = totalHours.toFixed(1);
                 } else {
                     // If start or end time is not a valid number, clear the total
                     totalHoursInput.value = '';
                 }

            } catch (error) {
                console.error('Errore nel calcolo delle ore totali:', error);
                totalHoursInput.value = ''; // Clear total on error
            }
        }

         /**
         * Simple HTML escaping function
         */
         function escapeHtml(unsafe) {
             if (typeof unsafe !== 'string') return unsafe; // Return non-strings as is
             return unsafe
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
         }


        // --- QR Code Generation ---
         function generateQRCodes() {
             console.log("Generazione QR Code...");
             const websiteUrl = "https://www.pwsgroup.eu/";
             // Simplified VCard for better compatibility
             const contactsVCard = `BEGIN:VCARD
VERSION:3.0
FN:PWS Group
ORG:PWS Group
TEL;TYPE=WORK,VOICE:0293219393
ADR;TYPE=WORK:;;Via G. Boccaccio, 95/c;Trezzano S.N;MI;20090;Italy
URL:${websiteUrl}
END:VCARD`;

             const qrWebsiteContainer = document.getElementById('qrcode');
             const qrContactsContainer = document.getElementById('contacts-qrcode');

              // Ensure QRCode library is loaded
             if (typeof QRCode === 'undefined') {
                 console.error("Libreria QRCode.js non caricata. Impossibile generare QR code.");
                 // Optionally display a message in the containers
                  if(qrWebsiteContainer) qrWebsiteContainer.innerHTML = '<p style="font-size:0.8rem; color: var(--md-sys-color-error);">Errore caricamento QR</p>';
                  if(qrContactsContainer) qrContactsContainer.innerHTML = '<p style="font-size:0.8rem; color: var(--md-sys-color-error);">Errore caricamento QR</p>';
                 return;
             }

             try {
                 // Generate Website QR
                 if (qrWebsiteContainer) {
                     qrWebsiteContainer.innerHTML = ''; // Clear previous/static content
                     new QRCode(qrWebsiteContainer, {
                         text: websiteUrl,
                         width: 180,
                         height: 180,
                         colorDark : "#000000",
                         colorLight : "#ffffff",
                         correctLevel : QRCode.CorrectLevel.H // High correction for reliability
                     });
                      console.log("QR Code sito web generato.");
                 } else { console.warn("Contenitore QR code sito web (#qrcode) non trovato."); }

                 // Generate Contacts QR
                 if (qrContactsContainer) {
                     qrContactsContainer.innerHTML = ''; // Clear previous/static content
                     new QRCode(qrContactsContainer, {
                         text: contactsVCard,
                         width: 180,
                         height: 180,
                         colorDark : "#000000",
                         colorLight : "#ffffff",
                         correctLevel : QRCode.CorrectLevel.M // Medium correction for VCard data
                     });
                      console.log("QR Code contatti generato.");
                  } else { console.warn("Contenitore QR code contatti (#contacts-qrcode) non trovato."); }

             } catch (e) {
                 console.error("Errore durante la generazione dei QR code con QRCode.js:", e);
                 showToast("Errore nella generazione dei QR code.", "error");
                  // Optionally display error message in containers
             }
         }


    </script>

</body>
</html>
